<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cloak & Cannon</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&display=swap');

        body {
            margin: 0;
            padding: 0;
            background-color: #1a1a1a;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            overflow: hidden;
            font-family: 'Orbitron', sans-serif;
            color: #ecf0f1;
        }

        #game-container {
            position: relative;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.8);
            border: 2px solid #333;
            width: 800px;
            height: 600px;
        }

        #ui-layer {
            position: absolute;
            top: 10px;
            left: 10px;
            width: 200px;
            background: rgba(10, 15, 20, 0.85);
            backdrop-filter: blur(5px);
            border: 1px solid rgba(100, 200, 255, 0.2);
            border-radius: 4px;
            padding: 10px;
            pointer-events: none;
        }

        h2 {
            margin: 0 0 10px 0;
            font-size: 16px;
            color: #00d2ff;
            text-transform: uppercase;
            border-bottom: 1px solid rgba(0, 210, 255, 0.3);
            padding-bottom: 5px;
        }

        .crew-member {
            display: flex;
            justify-content: space-between;
            font-size: 12px;
            margin-bottom: 5px;
            color: #bdc3c7;
        }

        .crew-role {
            color: #7f8c8d;
            font-size: 10px;
        }

        .status-ok {
            color: #2ecc71;
        }

        .status-alert {
            color: #e74c3c;
        }

        #mission-status {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(10, 15, 20, 0.85);
            padding: 10px;
            border: 1px solid #e67e22;
            color: #e67e22;
            font-size: 14px;
            font-weight: bold;
            display: none;
            pointer-events: none;
        }
    </style>
</head>

<body>

    <div id="game-container">
        <div id="ui-layer">
            <h2>Tank Crew</h2>
            <div class="crew-member">
                <span>Simon</span> <span class="crew-role">CMDR</span> <span class="status-ok">ACTIVE</span>
            </div>
            <div class="crew-member">
                <span>Louis</span> <span class="crew-role">GNR</span> <span class="status-ok">ACTIVE</span>
            </div>
            <div class="crew-member">
                <span>Remy</span> <span class="crew-role">DRVR</span> <span class="status-ok">ACTIVE</span>
            </div>
            <div class="crew-member">
                <span>Jules</span> <span class="crew-role">LDR</span> <span class="status-ok">ACTIVE</span>
            </div>
        </div>
        <div id="mission-status">OBJECTIVE SECURED! RETURN TO EXTRACT!</div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/phaser@3.60.0/dist/phaser.min.js"></script>
    <script>
        const ASSET_URL = 'https://imagedelivery.net/PwwFoxX145pJ1GHCG1Npzg/2725ffe6-68a3-4f76-e90b-7dd61b44ac00/public';

        const ATLAS_JSON = {
            "frames": {
                "barrelBlack_side.png": { "frame": { "x": 513, "y": 407, "w": 20, "h": 28 } },
                "barrelBlack_top.png": { "frame": { "x": 507, "y": 515, "w": 24, "h": 24 } },
                "barrelGreen_side.png": { "frame": { "x": 513, "y": 319, "w": 20, "h": 28 } },
                "barrelGreen_top.png": { "frame": { "x": 507, "y": 443, "w": 24, "h": 24 } },
                "barrelRed_side.png": { "frame": { "x": 414, "y": 371, "w": 20, "h": 28 } },
                "barrelRed_top.png": { "frame": { "x": 507, "y": 491, "w": 24, "h": 24 } },
                "barrelRust_side.png": { "frame": { "x": 512, "y": 40, "w": 20, "h": 28 } },
                "barrelRust_top.png": { "frame": { "x": 507, "y": 467, "w": 24, "h": 24 } },
                "barricadeMetal.png": { "frame": { "x": 479, "y": 499, "w": 28, "h": 28 } },
                "barricadeWood.png": { "frame": { "x": 479, "y": 527, "w": 28, "h": 28 } },
                "bulletBlue1.png": { "frame": { "x": 356, "y": 555, "w": 4, "h": 10 } },
                "bulletBlue1_outline.png": { "frame": { "x": 544, "y": 26, "w": 8, "h": 14 } },
                "bulletBlue2.png": { "frame": { "x": 532, "y": 48, "w": 8, "h": 12 } },
                "bulletBlue2_outline.png": { "frame": { "x": 438, "y": 455, "w": 12, "h": 16 } },
                "bulletBlue3.png": { "frame": { "x": 500, "y": 130, "w": 4, "h": 14 } },
                "bulletBlue3_outline.png": { "frame": { "x": 513, "y": 202, "w": 8, "h": 18 } },
                "bulletDark1.png": { "frame": { "x": 386, "y": 393, "w": 4, "h": 10 } },
                "bulletDark1_outline.png": { "frame": { "x": 462, "y": 455, "w": 8, "h": 14 } },
                "bulletDark2.png": { "frame": { "x": 470, "y": 455, "w": 8, "h": 12 } },
                "bulletDark2_outline.png": { "frame": { "x": 196, "y": 544, "w": 12, "h": 16 } },
                "bulletDark3.png": { "frame": { "x": 435, "y": 231, "w": 4, "h": 14 } },
                "bulletDark3_outline.png": { "frame": { "x": 531, "y": 517, "w": 8, "h": 18 } },
                "bulletGreen1.png": { "frame": { "x": 435, "y": 245, "w": 4, "h": 10 } },
                "bulletGreen1_outline.png": { "frame": { "x": 532, "y": 160, "w": 8, "h": 14 } },
                "bulletGreen2.png": { "frame": { "x": 521, "y": 202, "w": 8, "h": 12 } },
                "bulletGreen2_outline.png": { "frame": { "x": 172, "y": 544, "w": 12, "h": 16 } },
                "bulletGreen3.png": { "frame": { "x": 471, "y": 283, "w": 4, "h": 14 } },
                "bulletGreen3_outline.png": { "frame": { "x": 492, "y": 130, "w": 8, "h": 18 } },
                "bulletRed1.png": { "frame": { "x": 382, "y": 393, "w": 4, "h": 10 } },
                "bulletRed1_outline.png": { "frame": { "x": 344, "y": 551, "w": 8, "h": 14 } },
                "bulletRed2.png": { "frame": { "x": 336, "y": 551, "w": 8, "h": 12 } },
                "bulletRed2_outline.png": { "frame": { "x": 184, "y": 544, "w": 12, "h": 16 } },
                "bulletRed3.png": { "frame": { "x": 206, "y": 528, "w": 4, "h": 14 } },
                "bulletRed3_outline.png": { "frame": { "x": 484, "y": 130, "w": 8, "h": 18 } },
                "bulletSand1.png": { "frame": { "x": 352, "y": 555, "w": 4, "h": 10 } },
                "bulletSand1_outline.png": { "frame": { "x": 320, "y": 551, "w": 8, "h": 14 } },
                "bulletSand2.png": { "frame": { "x": 312, "y": 551, "w": 8, "h": 12 } },
                "bulletSand2_outline.png": { "frame": { "x": 450, "y": 455, "w": 12, "h": 16 } },
                "bulletSand3.png": { "frame": { "x": 471, "y": 297, "w": 4, "h": 14 } },
                "bulletSand3_outline.png": { "frame": { "x": 476, "y": 130, "w": 8, "h": 18 } },
                "crateMetal.png": { "frame": { "x": 479, "y": 471, "w": 28, "h": 28 } },
                "crateMetal_side.png": { "frame": { "x": 479, "y": 443, "w": 28, "h": 28 } },
                "crateWood.png": { "frame": { "x": 480, "y": 221, "w": 28, "h": 28 } },
                "crateWood_side.png": { "frame": { "x": 480, "y": 249, "w": 28, "h": 28 } },
                "explosion1.png": { "frame": { "x": 320, "y": 403, "w": 60, "h": 60 } },
                "explosion2.png": { "frame": { "x": 380, "y": 471, "w": 57, "h": 56 } },
                "explosion3.png": { "frame": { "x": 0, "y": 128, "w": 64, "h": 63 } },
                "explosion4.png": { "frame": { "x": 430, "y": 104, "w": 46, "h": 45 } },
                "explosion5.png": { "frame": { "x": 53, "y": 512, "w": 53, "h": 52 } },
                "explosionSmoke1.png": { "frame": { "x": 320, "y": 463, "w": 60, "h": 60 } },
                "explosionSmoke2.png": { "frame": { "x": 382, "y": 255, "w": 57, "h": 56 } },
                "explosionSmoke3.png": { "frame": { "x": 320, "y": 192, "w": 63, "h": 63 } },
                "explosionSmoke4.png": { "frame": { "x": 384, "y": 104, "w": 46, "h": 45 } },
                "explosionSmoke5.png": { "frame": { "x": 0, "y": 512, "w": 53, "h": 52 } },
                "fenceRed.png": { "frame": { "x": 158, "y": 528, "w": 48, "h": 16 } },
                "fenceYellow.png": { "frame": { "x": 158, "y": 512, "w": 52, "h": 16 } },
                "oilSpill_large.png": { "frame": { "x": 262, "y": 512, "w": 50, "h": 50 } },
                "oilSpill_small.png": { "frame": { "x": 158, "y": 544, "w": 14, "h": 14 } },
                "sandbagBeige.png": { "frame": { "x": 382, "y": 371, "w": 32, "h": 22 } },
                "sandbagBeige_open.png": { "frame": { "x": 354, "y": 527, "w": 42, "h": 28 } },
                "sandbagBrown.png": { "frame": { "x": 439, "y": 283, "w": 32, "h": 22 } },
                "sandbagBrown_open.png": { "frame": { "x": 312, "y": 523, "w": 42, "h": 28 } },
                "shotLarge.png": { "frame": { "x": 507, "y": 539, "w": 20, "h": 25 } },
                "shotOrange.png": { "frame": { "x": 514, "y": 289, "w": 16, "h": 28 } },
                "shotRed.png": { "frame": { "x": 508, "y": 221, "w": 21, "h": 38 } },
                "shotThin.png": { "frame": { "x": 546, "y": 160, "w": 8, "h": 26 } },
                "specialBarrel1.png": { "frame": { "x": 530, "y": 0, "w": 14, "h": 22 } },
                "specialBarrel1_outline.png": { "frame": { "x": 527, "y": 539, "w": 18, "h": 26 } },
                "specialBarrel2.png": { "frame": { "x": 544, "y": 108, "w": 12, "h": 24 } },
                "specialBarrel2_outline.png": { "frame": { "x": 513, "y": 174, "w": 16, "h": 28 } },
                "specialBarrel3.png": { "frame": { "x": 544, "y": 132, "w": 10, "h": 28 } },
                "specialBarrel3_outline.png": { "frame": { "x": 530, "y": 244, "w": 14, "h": 32 } },
                "specialBarrel4.png": { "frame": { "x": 544, "y": 244, "w": 10, "h": 32 } },
                "specialBarrel4_outline.png": { "frame": { "x": 530, "y": 276, "w": 14, "h": 36 } },
                "specialBarrel5.png": { "frame": { "x": 531, "y": 435, "w": 12, "h": 26 } },
                "specialBarrel5_outline.png": { "frame": { "x": 514, "y": 98, "w": 16, "h": 30 } },
                "specialBarrel6.png": { "frame": { "x": 544, "y": 276, "w": 8, "h": 26 } },
                "specialBarrel6_outline.png": { "frame": { "x": 533, "y": 312, "w": 12, "h": 30 } },
                "specialBarrel7.png": { "frame": { "x": 544, "y": 0, "w": 8, "h": 26 } },
                "specialBarrel7_outline.png": { "frame": { "x": 530, "y": 68, "w": 12, "h": 30 } },
                "tankBlue_barrel1.png": { "frame": { "x": 531, "y": 461, "w": 12, "h": 26 } },
                "tankBlue_barrel1_outline.png": { "frame": { "x": 514, "y": 259, "w": 16, "h": 30 } },
                "tankBlue_barrel2.png": { "frame": { "x": 545, "y": 302, "w": 8, "h": 26 } },
                "tankBlue_barrel2_outline.png": { "frame": { "x": 542, "y": 48, "w": 12, "h": 30 } },
                "tankBlue_barrel3.png": { "frame": { "x": 545, "y": 519, "w": 8, "h": 26 } },
                "tankBlue_barrel3_outline.png": { "frame": { "x": 543, "y": 459, "w": 12, "h": 30 } },
                "tankBody_bigRed.png": { "frame": { "x": 384, "y": 56, "w": 48, "h": 48 } },
                "tankBody_bigRed_outline.png": { "frame": { "x": 106, "y": 512, "w": 52, "h": 52 } },
                "tankBody_blue.png": { "frame": { "x": 396, "y": 527, "w": 38, "h": 38 } },
                "tankBody_blue_outline.png": { "frame": { "x": 426, "y": 149, "w": 42, "h": 42 } },
                "tankBody_dark.png": { "frame": { "x": 468, "y": 149, "w": 38, "h": 36 } },
                "tankBody_darkLarge.png": { "frame": { "x": 384, "y": 0, "w": 48, "h": 56 } },
                "tankBody_darkLarge_outline.png": { "frame": { "x": 382, "y": 311, "w": 52, "h": 60 } },
                "tankBody_dark_outline.png": { "frame": { "x": 384, "y": 149, "w": 42, "h": 40 } },
                "tankBody_green.png": { "frame": { "x": 476, "y": 283, "w": 38, "h": 36 } },
                "tankBody_green_outline.png": { "frame": { "x": 435, "y": 191, "w": 42, "h": 40 } },
                "tankBody_huge.png": { "frame": { "x": 380, "y": 403, "w": 58, "h": 68 } },
                "tankBody_huge_outline.png": { "frame": { "x": 320, "y": 331, "w": 62, "h": 72 } },
                "tankBody_red.png": { "frame": { "x": 479, "y": 407, "w": 34, "h": 36 } },
                "tankBody_red_outline.png": { "frame": { "x": 476, "y": 0, "w": 38, "h": 40 } },
                "tankBody_sand.png": { "frame": { "x": 476, "y": 94, "w": 38, "h": 36 } },
                "tankBody_sand_outline.png": { "frame": { "x": 437, "y": 517, "w": 42, "h": 40 } },
                "tankDark_barrel1.png": { "frame": { "x": 543, "y": 342, "w": 12, "h": 26 } },
                "tankDark_barrel1_outline.png": { "frame": { "x": 514, "y": 68, "w": 16, "h": 30 } },
                "tankDark_barrel2.png": { "frame": { "x": 545, "y": 398, "w": 8, "h": 26 } },
                "tankDark_barrel2_outline.png": { "frame": { "x": 531, "y": 373, "w": 12, "h": 30 } },
                "tankDark_barrel3.png": { "frame": { "x": 553, "y": 519, "w": 8, "h": 26 } },
                "tankDark_barrel3_outline.png": { "frame": { "x": 543, "y": 429, "w": 12, "h": 30 } },
                "tankGreen_barrel1.png": { "frame": { "x": 533, "y": 403, "w": 12, "h": 26 } },
                "tankGreen_barrel1_outline.png": { "frame": { "x": 515, "y": 377, "w": 16, "h": 30 } },
                "tankGreen_barrel2.png": { "frame": { "x": 553, "y": 398, "w": 8, "h": 26 } },
                "tankGreen_barrel2_outline.png": { "frame": { "x": 530, "y": 98, "w": 12, "h": 30 } },
                "tankGreen_barrel3.png": { "frame": { "x": 552, "y": 276, "w": 8, "h": 26 } },
                "tankGreen_barrel3_outline.png": { "frame": { "x": 531, "y": 487, "w": 12, "h": 30 } },
                "tankRed_barrel1.png": { "frame": { "x": 531, "y": 347, "w": 12, "h": 26 } },
                "tankRed_barrel1_outline.png": { "frame": { "x": 514, "y": 0, "w": 16, "h": 30 } },
                "tankRed_barrel2.png": { "frame": { "x": 546, "y": 212, "w": 8, "h": 26 } },
                "tankRed_barrel2_outline.png": { "frame": { "x": 543, "y": 368, "w": 12, "h": 30 } },
                "tankRed_barrel3.png": { "frame": { "x": 553, "y": 302, "w": 8, "h": 26 } },
                "tankRed_barrel3_outline.png": { "frame": { "x": 532, "y": 128, "w": 12, "h": 30 } },
                "tankSand_barrel1.png": { "frame": { "x": 532, "y": 22, "w": 12, "h": 26 } },
                "tankSand_barrel1_outline.png": { "frame": { "x": 515, "y": 347, "w": 16, "h": 30 } },
                "tankSand_barrel2.png": { "frame": { "x": 546, "y": 186, "w": 8, "h": 26 } },
                "tankSand_barrel2_outline.png": { "frame": { "x": 542, "y": 78, "w": 12, "h": 30 } },
                "tankSand_barrel3.png": { "frame": { "x": 552, "y": 0, "w": 8, "h": 26 } },
                "tankSand_barrel3_outline.png": { "frame": { "x": 543, "y": 489, "w": 12, "h": 30 } },
                "tank_bigRed.png": { "frame": { "x": 210, "y": 512, "w": 52, "h": 52 } },
                "tank_blue.png": { "frame": { "x": 432, "y": 48, "w": 42, "h": 46 } },
                "tank_dark.png": { "frame": { "x": 434, "y": 311, "w": 42, "h": 46 } },
                "tank_darkLarge.png": { "frame": { "x": 383, "y": 192, "w": 52, "h": 60 } },
                "tank_green.png": { "frame": { "x": 434, "y": 357, "w": 42, "h": 46 } },
                "tank_huge.png": { "frame": { "x": 320, "y": 255, "w": 62, "h": 76 } },
                "tank_red.png": { "frame": { "x": 474, "y": 48, "w": 38, "h": 46 } },
                "tank_sand.png": { "frame": { "x": 437, "y": 471, "w": 42, "h": 46 } },
                "tileGrass1.png": { "frame": { "x": 192, "y": 384, "w": 64, "h": 64 } },
                "tileGrass2.png": { "frame": { "x": 192, "y": 320, "w": 64, "h": 64 } },
                "tileGrass_roadCornerLL.png": { "frame": { "x": 64, "y": 320, "w": 64, "h": 64 } },
                "tileGrass_roadCornerLR.png": { "frame": { "x": 64, "y": 384, "w": 64, "h": 64 } },
                "tileGrass_roadCornerUL.png": { "frame": { "x": 0, "y": 64, "w": 64, "h": 64 } },
                "tileGrass_roadCornerUR.png": { "frame": { "x": 192, "y": 256, "w": 64, "h": 64 } },
                "tileGrass_roadCrossing.png": { "frame": { "x": 0, "y": 319, "w": 64, "h": 64 } },
                "tileGrass_roadCrossingRound.png": { "frame": { "x": 64, "y": 0, "w": 64, "h": 64 } },
                "tileGrass_roadEast.png": { "frame": { "x": 64, "y": 128, "w": 64, "h": 64 } },
                "tileGrass_roadNorth.png": { "frame": { "x": 192, "y": 192, "w": 64, "h": 64 } },
                "tileGrass_roadSplitE.png": { "frame": { "x": 192, "y": 64, "w": 64, "h": 64 } },
                "tileGrass_roadSplitN.png": { "frame": { "x": 192, "y": 128, "w": 64, "h": 64 } },
                "tileGrass_roadSplitS.png": { "frame": { "x": 64, "y": 64, "w": 64, "h": 64 } },
                "tileGrass_roadSplitW.png": { "frame": { "x": 64, "y": 256, "w": 64, "h": 64 } },
                "tileGrass_roadTransitionE.png": { "frame": { "x": 192, "y": 0, "w": 64, "h": 64 } },
                "tileGrass_roadTransitionE_dirt.png": { "frame": { "x": 320, "y": 64, "w": 64, "h": 64 } },
                "tileGrass_roadTransitionN.png": { "frame": { "x": 320, "y": 0, "w": 64, "h": 64 } },
                "tileGrass_roadTransitionN_dirt.png": { "frame": { "x": 256, "y": 448, "w": 64, "h": 64 } },
                "tileGrass_roadTransitionS.png": { "frame": { "x": 256, "y": 384, "w": 64, "h": 64 } },
                "tileGrass_roadTransitionS_dirt.png": { "frame": { "x": 256, "y": 320, "w": 64, "h": 64 } },
                "tileGrass_roadTransitionW.png": { "frame": { "x": 256, "y": 256, "w": 64, "h": 64 } },
                "tileGrass_roadTransitionW_dirt.png": { "frame": { "x": 256, "y": 192, "w": 64, "h": 64 } },
                "tileGrass_transitionE.png": { "frame": { "x": 256, "y": 128, "w": 64, "h": 64 } },
                "tileGrass_transitionN.png": { "frame": { "x": 256, "y": 64, "w": 64, "h": 64 } },
                "tileGrass_transitionS.png": { "frame": { "x": 256, "y": 0, "w": 64, "h": 64 } },
                "tileGrass_transitionW.png": { "frame": { "x": 192, "y": 448, "w": 64, "h": 64 } },
                "tileSand1.png": { "frame": { "x": 128, "y": 0, "w": 64, "h": 64 } },
                "tileSand2.png": { "frame": { "x": 64, "y": 448, "w": 64, "h": 64 } },
                "tileSand_roadCornerLL.png": { "frame": { "x": 0, "y": 255, "w": 64, "h": 64 } },
                "tileSand_roadCornerLR.png": { "frame": { "x": 0, "y": 191, "w": 64, "h": 64 } },
                "tileSand_roadCornerUL.png": { "frame": { "x": 0, "y": 0, "w": 64, "h": 64 } },
                "tileSand_roadCornerUR.png": { "frame": { "x": 0, "y": 383, "w": 64, "h": 64 } },
                "tileSand_roadCrossing.png": { "frame": { "x": 320, "y": 128, "w": 64, "h": 64 } },
                "tileSand_roadCrossingRound.png": { "frame": { "x": 128, "y": 448, "w": 64, "h": 64 } },
                "tileSand_roadEast.png": { "frame": { "x": 128, "y": 384, "w": 64, "h": 64 } },
                "tileSand_roadNorth.png": { "frame": { "x": 128, "y": 320, "w": 64, "h": 64 } },
                "tileSand_roadSplitE.png": { "frame": { "x": 128, "y": 256, "w": 64, "h": 64 } },
                "tileSand_roadSplitN.png": { "frame": { "x": 128, "y": 192, "w": 64, "h": 64 } },
                "tileSand_roadSplitS.png": { "frame": { "x": 128, "y": 128, "w": 64, "h": 64 } },
                "tileSand_roadSplitW.png": { "frame": { "x": 128, "y": 64, "w": 64, "h": 64 } },
                "tracksDouble.png": { "frame": { "x": 438, "y": 403, "w": 41, "h": 52 } },
                "tracksLarge.png": { "frame": { "x": 439, "y": 231, "w": 41, "h": 52 } },
                "tracksSmall.png": { "frame": { "x": 476, "y": 319, "w": 37, "h": 52 } },
                "treeBrown_large.png": { "frame": { "x": 64, "y": 192, "w": 64, "h": 64 } },
                "treeBrown_leaf.png": { "frame": { "x": 312, "y": 512, "w": 8, "h": 10 } },
                "treeBrown_small.png": { "frame": { "x": 479, "y": 371, "w": 36, "h": 36 } },
                "treeBrown_twigs.png": { "frame": { "x": 506, "y": 130, "w": 26, "h": 22 } },
                "treeGreen_large.png": { "frame": { "x": 0, "y": 447, "w": 64, "h": 64 } },
                "treeGreen_leaf.png": { "frame": { "x": 328, "y": 555, "w": 8, "h": 10 } },
                "treeGreen_small.png": { "frame": { "x": 477, "y": 185, "w": 36, "h": 36 } },
                "treeGreen_twigs.png": { "frame": { "x": 506, "y": 152, "w": 26, "h": 22 } },
                "wireCrooked.png": { "frame": { "x": 432, "y": 0, "w": 44, "h": 48 } },
                "wireStraight.png": { "frame": { "x": 529, "y": 174, "w": 17, "h": 70 } }
            }
        };

        const config = {
            type: Phaser.AUTO,
            width: 800,
            height: 600,
            parent: 'game-container',
            physics: {
                default: 'arcade',
                arcade: {
                    debug: false,
                    gravity: { y: 0 }
                }
            },
            scene: {
                preload: preload,
                create: create,
                update: update
            }
        };

        const game = new Phaser.Game(config);

        let player;
        let cursors;
        let bullets;
        let obstacles;
        let hazards;
        let sentries = [];
        let sentryHulls;
        let objective;
        let extractionZone;
        let isObjectiveCollected = false;
        let isMissionComplete = false;
        let rayGraphics;

        class Bullet extends Phaser.Physics.Arcade.Sprite {
            constructor(scene, x, y) {
                super(scene, x, y, 'tanks', 'bulletBlue3.png');
                this.bounceCount = 0;
                this.isPlayerBullet = false;
            }

            fire(x, y, rotation, isPlayerBullet) {
                this.body.reset(x, y);
                this.setActive(true);
                this.setVisible(true);
                this.setRotation(rotation);
                this.isPlayerBullet = isPlayerBullet;

                this.setFrame(isPlayerBullet ? 'bulletBlue3.png' : 'bulletRed3.png');

                const vec = new Phaser.Math.Vector2();
                vec.setToPolar(rotation - Math.PI / 2, 40);
                this.setPosition(x + vec.x, y + vec.y);

                this.scene.physics.velocityFromRotation(rotation - Math.PI / 2, 400, this.body.velocity);
                this.bounceCount = 0;
            }

            reset() {
                this.setActive(false);
                this.setVisible(false);
                this.body.stop();
            }
        }

        class Tank {
            constructor(scene, x, y, textureBody, textureBarrel) {
                this.scene = scene;
                this.x = x;
                this.y = y;

                this.hull = scene.physics.add.sprite(x, y, 'tanks', textureBody);
                this.hull.setDrag(100);
                this.hull.setAngularDrag(100);
                this.hull.setMaxVelocity(200);
                this.hull.setCollideWorldBounds(true);

                this.turret = scene.add.sprite(x, y, 'tanks', textureBarrel);
                this.turret.setOrigin(0.5, 0.7);

                this.lastFired = 0;
                this.active = true;
            }

            update() {
                if (!this.active) return;
                this.turret.x = this.hull.x;
                this.turret.y = this.hull.y;
            }

            destroy() {
                this.hull.destroy();
                this.turret.destroy();
                this.active = false;
            }
        }

        class PlayerTank extends Tank {
            constructor(scene, x, y) {
                super(scene, x, y, 'tankBody_blue_outline.png', 'tankBlue_barrel1_outline.png');
                this.speed = 150;
            }

            update(time, cursors, pointer) {
                if (!this.active) return;
                super.update();

                this.hull.setVelocity(0);

                const velocity = new Phaser.Math.Vector2();

                if (cursors.left.isDown || cursors.a.isDown) {
                    velocity.x -= 1;
                } else if (cursors.right.isDown || cursors.d.isDown) {
                    velocity.x += 1;
                }

                if (cursors.up.isDown || cursors.w.isDown) {
                    velocity.y -= 1;
                } else if (cursors.down.isDown || cursors.s.isDown) {
                    velocity.y += 1;
                }

                if (velocity.length() > 0) {
                    velocity.normalize().scale(this.speed);
                    this.hull.setVelocity(velocity.x, velocity.y);

                    const angle = Phaser.Math.Angle.Between(0, 0, velocity.x, velocity.y);
                    this.hull.rotation = Phaser.Math.Angle.RotateTo(this.hull.rotation, angle + Math.PI / 2, 0.1);
                }

                const angleToMouse = Phaser.Math.Angle.Between(this.hull.x, this.hull.y, pointer.worldX, pointer.worldY);
                this.turret.rotation = angleToMouse + Math.PI / 2;

                if (pointer.isDown && time > this.lastFired) {
                    const bullet = bullets.get();
                    if (bullet) {
                        bullet.fire(this.hull.x, this.hull.y, this.turret.rotation, true);
                        this.lastFired = time + 500;
                    }
                }
            }
        }

        class SentryTank extends Tank {
            constructor(scene, path) {
                super(scene, path[0].x, path[0].y, 'tankBody_darkLarge_outline.png', 'tankDark_barrel1_outline.png');
                this.path = path;
                this.pathIndex = 0;
                this.speed = 80;
                this.visionRange = 250;
                this.visionAngle = Phaser.Math.DegToRad(45);
                this.state = 'PATROL';
                this.alertTimer = 0;
                this.hull.setData('parent', this);
            }

            update(time, player) {
                if (!this.active) return;
                super.update();

                if (isMissionComplete) return;

                if (isObjectiveCollected && this.state !== 'CHASE') {
                    this.state = 'CHASE';
                }

                switch (this.state) {
                    case 'PATROL':
                        this.patrolBehavior();
                        if (this.canSeePlayer(player)) {
                            this.state = 'CHASE';
                            this.alertUI();
                        }
                        break;
                    case 'CHASE':
                        this.chaseBehavior(time, player);
                        break;
                }
            }

            patrolBehavior() {
                const target = this.path[this.pathIndex];
                const distance = Phaser.Math.Distance.Between(this.hull.x, this.hull.y, target.x, target.y);

                if (distance < 5) {
                    this.pathIndex = (this.pathIndex + 1) % this.path.length;
                } else {
                    this.moveTo(target.x, target.y);
                }
            }

            chaseBehavior(time, player) {
                if (!player.active) return;
                this.moveTo(player.hull.x, player.hull.y);

                const angle = Phaser.Math.Angle.Between(this.hull.x, this.hull.y, player.hull.x, player.hull.y);
                this.turret.rotation = angle + Math.PI / 2;

                const facingAngle = this.hull.rotation - Math.PI / 2;
                const turretAngle = this.turret.rotation - Math.PI / 2;
                const diff = Phaser.Math.Angle.Wrap(angle - turretAngle);

                if (Math.abs(diff) < 0.2 && time > this.lastFired && this.canSeePlayer(player)) {
                    const bullet = bullets.get();
                    if (bullet) {
                        bullet.fire(this.hull.x, this.hull.y, this.turret.rotation, false);
                        this.lastFired = time + 1500;
                    }
                }
            }

            moveTo(tx, ty) {
                const angle = Phaser.Math.Angle.Between(this.hull.x, this.hull.y, tx, ty);
                const velocity = this.scene.physics.velocityFromRotation(angle, this.speed);
                this.hull.setVelocity(velocity.x, velocity.y);
                this.hull.rotation = Phaser.Math.Angle.RotateTo(this.hull.rotation, angle + Math.PI / 2, 0.1);
                if (this.state === 'PATROL') this.turret.rotation = this.hull.rotation;
            }

            canSeePlayer(player) {
                if (!player.active) return false;
                const dist = Phaser.Math.Distance.Between(this.hull.x, this.hull.y, player.hull.x, player.hull.y);
                if (dist > this.visionRange) return false;

                const angleToPlayer = Phaser.Math.Angle.Between(this.hull.x, this.hull.y, player.hull.x, player.hull.y);
                const facingAngle = this.turret.rotation - Math.PI / 2;
                let diff = Phaser.Math.Angle.Wrap(angleToPlayer - facingAngle);

                if (Math.abs(diff) < this.visionAngle / 2) {
                    const line = new Phaser.Geom.Line(this.hull.x, this.hull.y, player.hull.x, player.hull.y);
                    let blocked = false;
                    obstacles.getChildren().forEach(obs => {
                        if (Phaser.Geom.Intersects.LineToRectangle(line, obs.getBounds())) blocked = true;
                    });
                    return !blocked;
                }
                return false;
            }

            alertUI() {
                const startColor = Phaser.Display.Color.ValueToColor(0xffffff);
                const endColor = Phaser.Display.Color.ValueToColor(0xff0000);
                this.scene.tweens.addCounter({
                    from: 0,
                    to: 100,
                    duration: 500,
                    onUpdate: tween => {
                        const value = tween.getValue();
                        const col = Phaser.Display.Color.Interpolate.ColorWithColor(startColor, endColor, 100, value);
                        this.turret.setTint(Phaser.Display.Color.GetColor(col.r, col.g, col.b));
                    }
                });
                document.querySelectorAll('.status-ok').forEach(el => {
                    el.className = 'status-alert';
                    el.innerText = 'DANGER';
                });
            }

            explode() {
                const particles = this.scene.add.particles(this.hull.x, this.hull.y, 'tanks', {
                    frame: 'explosion1.png',
                    speed: 50,
                    scale: { start: 1, end: 0 },
                    duration: 500,
                    maxParticles: 10
                });
                this.destroy();
            }
        }

        function preload() {
            this.load.image('tanks_sheet', ASSET_URL);
        }

        function create() {
            this.textures.addAtlas('tanks', this.textures.get('tanks_sheet').source[0].image, ATLAS_JSON);

            cursors = this.input.keyboard.createCursorKeys();
            cursors.w = this.input.keyboard.addKey(Phaser.Input.Keyboard.KeyCodes.W);
            cursors.a = this.input.keyboard.addKey(Phaser.Input.Keyboard.KeyCodes.A);
            cursors.s = this.input.keyboard.addKey(Phaser.Input.Keyboard.KeyCodes.S);
            cursors.d = this.input.keyboard.addKey(Phaser.Input.Keyboard.KeyCodes.D);

            for (let y = 0; y < 600; y += 64) {
                for (let x = 0; x < 800; x += 64) this.add.image(x + 32, y + 32, 'tanks', 'tileGrass1.png');
            }

            for (let x = 100; x < 700; x += 64) this.add.image(x, 100, 'tanks', 'tileGrass_roadEast.png');
            for (let x = 100; x < 700; x += 64) this.add.image(x, 500, 'tanks', 'tileGrass_roadEast.png');
            for (let y = 100; y < 500; y += 64) this.add.image(100, y, 'tanks', 'tileGrass_roadNorth.png');
            for (let y = 100; y < 500; y += 64) this.add.image(700, y, 'tanks', 'tileGrass_roadNorth.png');
            this.add.image(100, 100, 'tanks', 'tileGrass_roadCornerLR.png');
            this.add.image(700, 100, 'tanks', 'tileGrass_roadCornerLL.png');
            this.add.image(100, 500, 'tanks', 'tileGrass_roadCornerUR.png');
            this.add.image(700, 500, 'tanks', 'tileGrass_roadCornerUL.png');

            obstacles = this.physics.add.staticGroup();
            obstacles.create(400, 300, 'tanks', 'crateMetal.png');
            obstacles.create(300, 300, 'tanks', 'treeGreen_large.png');
            obstacles.create(500, 300, 'tanks', 'treeGreen_large.png');
            obstacles.create(200, 200, 'tanks', 'crateWood.png');
            obstacles.create(600, 400, 'tanks', 'crateWood.png');

            hazards = this.physics.add.staticGroup();
            this.add.image(250, 450, 'tanks', 'wireCrooked.png').setAngle(45);
            const oil = this.physics.add.image(550, 150, 'tanks', 'oilSpill_large.png');

            bullets = this.physics.add.group({
                classType: Bullet,
                maxSize: 50,
                runChildUpdate: false
            });

            sentryHulls = this.physics.add.group();
            sentries = [];

            player = new PlayerTank(this, 100, 300);

            extractionZone = this.add.rectangle(100, 300, 100, 100, 0x00ff00, 0.2);
            this.physics.add.existing(extractionZone, true);

            objective = this.physics.add.image(700, 300, 'tanks', 'specialBarrel1_outline.png');

            const s1 = new SentryTank(this, [{ x: 200, y: 100 }, { x: 600, y: 100 }]);
            sentries.push(s1);
            sentryHulls.add(s1.hull);

            const s2 = new SentryTank(this, [{ x: 600, y: 500 }, { x: 200, y: 500 }]);
            sentries.push(s2);
            sentryHulls.add(s2.hull);

            this.physics.add.collider(player.hull, obstacles);
            this.physics.add.collider(sentryHulls, obstacles);
            this.physics.add.collider(player.hull, sentryHulls);

            this.physics.add.collider(bullets, obstacles, (bullet, obstacle) => {
                if (!bullet.active) return;
                if (bullet.bounceCount < 1) {
                    bullet.bounceCount++;
                    const body = bullet.body;
                    if (body.touching.up || body.touching.down) body.velocity.y *= -1;
                    if (body.touching.left || body.touching.right) body.velocity.x *= -1;
                    bullet.rotation = body.velocity.angle() + Math.PI / 2;
                } else {
                    bullet.reset();
                    if (obstacle.texture.key === 'tanks' && obstacle.frame.name.includes('crate')) {
                        obstacle.destroy();
                    }
                }
            });

            this.physics.add.overlap(bullets, sentryHulls, (bullet, hull) => {
                if (!bullet.active || !bullet.isPlayerBullet) return;

                bullet.reset();
                const sentry = hull.getData('parent');
                if (sentry && sentry.active) {
                    sentry.explode();
                }
            });

            this.physics.add.overlap(bullets, player.hull, (hull, bullet) => {
                if (!bullet.active || bullet.isPlayerBullet) return;

                bullet.reset();
                player.destroy();
                document.getElementById('mission-status').style.display = 'block';
                document.getElementById('mission-status').innerText = 'MISSION FAILED - TANK DESTROYED';
                document.getElementById('mission-status').style.color = '#e74c3c';
                document.getElementById('mission-status').style.borderColor = '#e74c3c';
                game.scene.pause('default');
            });

            this.physics.add.overlap(player.hull, oil, () => {
                player.hull.setVelocity(player.hull.body.velocity.x * 0.9, player.hull.body.velocity.y * 0.9);
            });

            this.physics.add.overlap(player.hull, objective, () => {
                isObjectiveCollected = true;
                objective.destroy();
                document.getElementById('mission-status').style.display = 'block';
                document.getElementById('mission-status').innerText = 'OBJECTIVE SECURED! RETURN TO EXTRACT!';
            });

            this.physics.add.overlap(player.hull, extractionZone, () => {
                if (isObjectiveCollected && !isMissionComplete) {
                    isMissionComplete = true;
                    document.getElementById('mission-status').innerText = 'MISSION ACCOMPLISHED!';
                    document.getElementById('mission-status').style.color = '#2ecc71';
                    document.getElementById('mission-status').style.borderColor = '#2ecc71';
                    this.scene.pause();
                }
            });

            rayGraphics = this.add.graphics();
        }

        function update(time, delta) {
            if (isMissionComplete) return;

            player.update(time, cursors, this.input.activePointer);
            sentries.forEach(s => s.update(time, player));

            rayGraphics.clear();

            sentries.forEach(s => {
                if (!s.active) return;
                rayGraphics.fillStyle(0xff0000, 0.2);
                const startAngle = s.turret.rotation - Math.PI / 2 - s.visionAngle / 2;
                rayGraphics.slice(s.hull.x, s.hull.y, s.visionRange, startAngle, startAngle + s.visionAngle, false);
                rayGraphics.fillPath();
            });
        }
    </script>
</body>

</html>