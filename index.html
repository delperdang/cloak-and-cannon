<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cloak & Cannon</title>
    <meta name="description"
        content="Cloak & Cannon is a top-down tactical stealth tank game. Infiltrate enemy lines, avoid sentries, and complete your mission in this intense browser-based arcade experience.">
    <meta name="keywords" content="tank game, stealth game, browser game, phaser.js, arcade, action, tactical">
    <meta name="robots" content="index, follow">
    <link rel="icon" href="https://imagedelivery.net/PwwFoxX145pJ1GHCG1Npzg/74faf358-754d-4a62-9543-a9bb6106aa00/public"
        type="image/svg+xml">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&display=swap');

        body {
            margin: 0;
            padding: 0;
            background-color: #050505;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            overflow: hidden;
            font-family: 'Orbitron', sans-serif;
            color: #ecf0f1;
        }

        #game-container {
            position: relative;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.8);
            border: none;
            width: 100%;
            height: 100vh;
        }

        #ui-layer {
            position: absolute;
            top: 10px;
            left: 10px;
            width: 200px;
            background: rgba(10, 15, 20, 0.85);
            backdrop-filter: blur(5px);
            border: 1px solid rgba(100, 200, 255, 0.2);
            border-radius: 4px;
            padding: 10px;
            pointer-events: none;
        }

        h2 {
            margin: 0 0 10px 0;
            font-size: 16px;
            color: #00d2ff;
            text-transform: uppercase;
            border-bottom: 1px solid rgba(0, 210, 255, 0.3);
            padding-bottom: 5px;
        }

        .crew-member {
            display: flex;
            justify-content: space-between;
            font-size: 12px;
            margin-bottom: 5px;
            color: #bdc3c7;
        }

        .crew-role {
            color: #7f8c8d;
            font-size: 10px;
        }

        .status-ok {
            color: #2ecc71;
        }

        .status-alert {
            color: #e74c3c;
        }

        #mission-status {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.8);
            border: 2px solid #e67e22;
            padding: 20px;
            color: #e67e22;
            font-size: 24px;
            font-weight: bold;
            display: none;
            text-align: center;
            z-index: 1000;
            pointer-events: none;
        }

        #powerup-selection-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 2000;
        }

        .powerup-card {
            background: rgba(20, 20, 20, 0.9);
            border: 2px solid #333;
            border-radius: 8px;
            padding: 20px;
            margin: 10px;
            width: 300px;
            cursor: pointer;
            transition: all 0.2s;
            text-align: center;
            color: #ecf0f1;
        }

        .powerup-card:hover {
            border-color: #3498db;
            background: rgba(40, 40, 60, 0.9);
            transform: translateY(-2px);
        }

        .powerup-title {
            font-size: 18px;
            font-weight: bold;
            color: #3498db;
            margin-bottom: 10px;
        }

        .powerup-type-cannon {
            color: #e74c3c;
        }

        .powerup-type-cloak {
            color: #9b59b6;
        }

        .powerup-desc {
            font-size: 14px;
            color: #bdc3c7;
            line-height: 1.4;
        }

        #powerup-hud {
            position: absolute;
            top: 60px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 10px;
            z-index: 500;
        }

        .powerup-slot {
            width: 40px;
            height: 40px;
            background: rgba(0, 0, 0, 0.6);
            border: 1px solid #555;
            border-radius: 4px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 10px;
            color: #7f8c8d;
            position: relative;
            cursor: pointer;
        }

        .powerup-slot.filled {
            border-color: #bdc3c7;
            color: #ecf0f1;
        }

        .powerup-slot.active {
            border-color: #f1c40f;
            box-shadow: 0 0 10px #f1c40f;
        }

        .powerup-slot.used {
            opacity: 0.3;
            filter: grayscale(100%);
            cursor: not-allowed;
        }

        .powerup-slot:not(.filled) {
            cursor: default;
        }

        .slot-cannon {
            border-bottom: 2px solid #e74c3c;
        }

        .slot-cloak {
            border-bottom: 2px solid #9b59b6;
        }

        .slot-key {
            position: absolute;
            top: -18px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 10px;
            color: #7f8c8d;
            background: rgba(0, 0, 0, 0.5);
            padding: 2px 4px;
            border-radius: 4px;
        }

        .active-timer-bar {
            position: absolute;
            bottom: 0;
            left: 0;
            height: 4px;
            background-color: #f1c40f;
            width: 0%;
            transition: width 0.1s linear;
        }

        @media (max-width: 800px) {
            #selection-container {
                flex-direction: column;
                gap: 10px !important;
            }

            .powerup-card {
                width: 80%;
                margin: 5px 0;
            }
        }

        @media (max-width: 1024px) {
            #ui-layer {
                display: none;
            }
        }

        @media (max-width: 600px) {
            #powerup-hud {
                gap: 2px;
            }

            .powerup-slot {
                width: 30px;
                height: 30px;
                font-size: 8px;
            }

            .slot-key {
                font-size: 8px;
                top: -14px;
            }
        }
    </style>
</head>

<body>

    <div id="game-container">
        <div id="ui-layer">
            <h2>Tank Crew</h2>
            <div class="crew-member">
                <span>Simon</span> <span class="crew-role">CMDR</span> <span class="status-ok">ACTIVE</span>
            </div>
            <div class="crew-member">
                <span>Louis</span> <span class="crew-role">GNR</span> <span class="status-ok">ACTIVE</span>
            </div>
            <div class="crew-member">
                <span>Remy</span> <span class="crew-role">DRVR</span> <span class="status-ok">ACTIVE</span>
            </div>
            <div class="crew-member">
                <span>Jules</span> <span class="crew-role">LDR</span> <span class="status-ok">ACTIVE</span>
            </div>
        </div>
        <div id="mission-status"></div>
    </div>

    <div id="powerup-selection-overlay">
        <h2 style="color: #fff; margin-bottom: 30px;">SELECT REWARD</h2>
        <div id="selection-container" style="display: flex; gap: 20px;">
            <div id="option-1" class="powerup-card" onclick="selectPowerup(0)">
                <div class="powerup-title">OPTION 1</div>
                <div class="powerup-desc">...</div>
            </div>
            <div id="option-2" class="powerup-card" onclick="selectPowerup(1)">
                <div class="powerup-title">OPTION 2</div>
                <div class="powerup-desc">...</div>
            </div>
        </div>
    </div>

    <div id="powerup-hud">
        <div class="powerup-slot slot-cannon" id="slot-0"><span class="slot-key">1</span></div>
        <div class="powerup-slot slot-cannon" id="slot-1"><span class="slot-key">2</span></div>
        <div class="powerup-slot slot-cannon" id="slot-2"><span class="slot-key">3</span></div>
        <div class="powerup-slot slot-cannon" id="slot-3"><span class="slot-key">4</span></div>
        <div class="powerup-slot slot-cannon" id="slot-4"><span class="slot-key">5</span></div>
        <div class="powerup-slot slot-cloak" id="slot-5"><span class="slot-key">6</span></div>
        <div class="powerup-slot slot-cloak" id="slot-6"><span class="slot-key">7</span></div>
        <div class="powerup-slot slot-cloak" id="slot-7"><span class="slot-key">8</span></div>
        <div class="powerup-slot slot-cloak" id="slot-8"><span class="slot-key">9</span></div>
        <div class="powerup-slot slot-cloak" id="slot-9"><span class="slot-key">0</span></div>
    </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/phaser@3.60.0/dist/phaser.min.js"></script>


    <script
        src="https://cdn.jsdelivr.net/gh/rexrainbow/phaser3-rex-notes@master/dist/rexvirtualjoystickplugin.min.js"></script>

    <script>
        const ASSET_URL = 'https://imagedelivery.net/PwwFoxX145pJ1GHCG1Npzg/2725ffe6-68a3-4f76-e90b-7dd61b44ac00/public';

        const ATLAS_JSON = {
            "frames": {
                "barrelBlack_side.png": { "frame": { "x": 513, "y": 407, "w": 20, "h": 28 } },
                "barrelBlack_top.png": { "frame": { "x": 507, "y": 515, "w": 24, "h": 24 } },
                "barrelGreen_side.png": { "frame": { "x": 513, "y": 319, "w": 20, "h": 28 } },
                "barrelGreen_top.png": { "frame": { "x": 507, "y": 443, "w": 24, "h": 24 } },
                "barrelRed_side.png": { "frame": { "x": 414, "y": 371, "w": 20, "h": 28 } },
                "barrelRed_top.png": { "frame": { "x": 507, "y": 491, "w": 24, "h": 24 } },
                "barrelRust_side.png": { "frame": { "x": 512, "y": 40, "w": 20, "h": 28 } },
                "barrelRust_top.png": { "frame": { "x": 507, "y": 467, "w": 24, "h": 24 } },
                "barricadeMetal.png": { "frame": { "x": 479, "y": 499, "w": 28, "h": 28 } },
                "barricadeWood.png": { "frame": { "x": 479, "y": 527, "w": 28, "h": 28 } },
                "bulletBlue1.png": { "frame": { "x": 356, "y": 555, "w": 4, "h": 10 } },
                "bulletBlue1_outline.png": { "frame": { "x": 544, "y": 26, "w": 8, "h": 14 } },
                "bulletBlue2.png": { "frame": { "x": 532, "y": 48, "w": 8, "h": 12 } },
                "bulletBlue2_outline.png": { "frame": { "x": 438, "y": 455, "w": 12, "h": 16 } },
                "bulletBlue3.png": { "frame": { "x": 500, "y": 130, "w": 4, "h": 14 } },
                "bulletBlue3_outline.png": { "frame": { "x": 513, "y": 202, "w": 8, "h": 18 } },
                "bulletDark1.png": { "frame": { "x": 386, "y": 393, "w": 4, "h": 10 } },
                "bulletDark1_outline.png": { "frame": { "x": 462, "y": 455, "w": 8, "h": 14 } },
                "bulletDark2.png": { "frame": { "x": 470, "y": 455, "w": 8, "h": 12 } },
                "bulletDark2_outline.png": { "frame": { "x": 196, "y": 544, "w": 12, "h": 16 } },
                "bulletDark3.png": { "frame": { "x": 435, "y": 231, "w": 4, "h": 14 } },
                "bulletDark3_outline.png": { "frame": { "x": 531, "y": 517, "w": 8, "h": 18 } },
                "bulletGreen1.png": { "frame": { "x": 435, "y": 245, "w": 4, "h": 10 } },
                "bulletGreen1_outline.png": { "frame": { "x": 532, "y": 160, "w": 8, "h": 14 } },
                "bulletGreen2.png": { "frame": { "x": 521, "y": 202, "w": 8, "h": 12 } },
                "bulletGreen2_outline.png": { "frame": { "x": 172, "y": 544, "w": 12, "h": 16 } },
                "bulletGreen3.png": { "frame": { "x": 471, "y": 283, "w": 4, "h": 14 } },
                "bulletGreen3_outline.png": { "frame": { "x": 492, "y": 130, "w": 8, "h": 18 } },
                "bulletRed1.png": { "frame": { "x": 382, "y": 393, "w": 4, "h": 10 } },
                "bulletRed1_outline.png": { "frame": { "x": 344, "y": 551, "w": 8, "h": 14 } },
                "bulletRed2.png": { "frame": { "x": 336, "y": 551, "w": 8, "h": 12 } },
                "bulletRed2_outline.png": { "frame": { "x": 184, "y": 544, "w": 12, "h": 16 } },
                "bulletRed3.png": { "frame": { "x": 206, "y": 528, "w": 4, "h": 14 } },
                "bulletRed3_outline.png": { "frame": { "x": 484, "y": 130, "w": 8, "h": 18 } },
                "bulletSand1.png": { "frame": { "x": 352, "y": 555, "w": 4, "h": 10 } },
                "bulletSand1_outline.png": { "frame": { "x": 320, "y": 551, "w": 8, "h": 14 } },
                "bulletSand2.png": { "frame": { "x": 312, "y": 551, "w": 8, "h": 12 } },
                "bulletSand2_outline.png": { "frame": { "x": 450, "y": 455, "w": 12, "h": 16 } },
                "bulletSand3.png": { "frame": { "x": 471, "y": 297, "w": 4, "h": 14 } },
                "bulletSand3_outline.png": { "frame": { "x": 476, "y": 130, "w": 8, "h": 18 } },
                "crateMetal.png": { "frame": { "x": 479, "y": 471, "w": 28, "h": 28 } },
                "crateMetal_side.png": { "frame": { "x": 479, "y": 443, "w": 28, "h": 28 } },
                "crateWood.png": { "frame": { "x": 480, "y": 221, "w": 28, "h": 28 } },
                "crateWood_side.png": { "frame": { "x": 480, "y": 249, "w": 28, "h": 28 } },
                "explosion1.png": { "frame": { "x": 320, "y": 403, "w": 60, "h": 60 } },
                "explosion2.png": { "frame": { "x": 380, "y": 471, "w": 57, "h": 56 } },
                "explosion3.png": { "frame": { "x": 0, "y": 128, "w": 64, "h": 63 } },
                "explosion4.png": { "frame": { "x": 430, "y": 104, "w": 46, "h": 45 } },
                "explosion5.png": { "frame": { "x": 53, "y": 512, "w": 53, "h": 52 } },
                "explosionSmoke1.png": { "frame": { "x": 320, "y": 463, "w": 60, "h": 60 } },
                "explosionSmoke2.png": { "frame": { "x": 382, "y": 255, "w": 57, "h": 56 } },
                "explosionSmoke3.png": { "frame": { "x": 320, "y": 192, "w": 63, "h": 63 } },
                "explosionSmoke4.png": { "frame": { "x": 384, "y": 104, "w": 46, "h": 45 } },
                "explosionSmoke5.png": { "frame": { "x": 0, "y": 512, "w": 53, "h": 52 } },
                "fenceRed.png": { "frame": { "x": 158, "y": 528, "w": 48, "h": 16 } },
                "fenceYellow.png": { "frame": { "x": 158, "y": 512, "w": 52, "h": 16 } },
                "oilSpill_large.png": { "frame": { "x": 262, "y": 512, "w": 50, "h": 50 } },
                "oilSpill_small.png": { "frame": { "x": 158, "y": 544, "w": 14, "h": 14 } },
                "sandbagBeige.png": { "frame": { "x": 382, "y": 371, "w": 32, "h": 22 } },
                "sandbagBeige_open.png": { "frame": { "x": 354, "y": 527, "w": 42, "h": 28 } },
                "sandbagBrown.png": { "frame": { "x": 439, "y": 283, "w": 32, "h": 22 } },
                "sandbagBrown_open.png": { "frame": { "x": 312, "y": 523, "w": 42, "h": 28 } },
                "shotLarge.png": { "frame": { "x": 507, "y": 539, "w": 20, "h": 25 } },
                "shotOrange.png": { "frame": { "x": 514, "y": 289, "w": 16, "h": 28 } },
                "shotRed.png": { "frame": { "x": 508, "y": 221, "w": 21, "h": 38 } },
                "shotThin.png": { "frame": { "x": 546, "y": 160, "w": 8, "h": 26 } },
                "specialBarrel1.png": { "frame": { "x": 530, "y": 0, "w": 14, "h": 22 } },
                "specialBarrel1_outline.png": { "frame": { "x": 527, "y": 539, "w": 18, "h": 26 } },
                "specialBarrel2.png": { "frame": { "x": 544, "y": 108, "w": 12, "h": 24 } },
                "specialBarrel2_outline.png": { "frame": { "x": 513, "y": 174, "w": 16, "h": 28 } },
                "specialBarrel3.png": { "frame": { "x": 544, "y": 132, "w": 10, "h": 28 } },
                "specialBarrel3_outline.png": { "frame": { "x": 530, "y": 244, "w": 14, "h": 32 } },
                "specialBarrel4.png": { "frame": { "x": 544, "y": 244, "w": 10, "h": 32 } },
                "specialBarrel4_outline.png": { "frame": { "x": 530, "y": 276, "w": 14, "h": 36 } },
                "specialBarrel5.png": { "frame": { "x": 531, "y": 435, "w": 12, "h": 26 } },
                "specialBarrel5_outline.png": { "frame": { "x": 514, "y": 98, "w": 16, "h": 30 } },
                "specialBarrel6.png": { "frame": { "x": 544, "y": 276, "w": 8, "h": 26 } },
                "specialBarrel6_outline.png": { "frame": { "x": 533, "y": 312, "w": 12, "h": 30 } },
                "specialBarrel7.png": { "frame": { "x": 544, "y": 0, "w": 8, "h": 26 } },
                "specialBarrel7_outline.png": { "frame": { "x": 530, "y": 68, "w": 12, "h": 30 } },
                "tankBlue_barrel1.png": { "frame": { "x": 531, "y": 461, "w": 12, "h": 26 } },
                "tankBlue_barrel1_outline.png": { "frame": { "x": 514, "y": 259, "w": 16, "h": 30 } },
                "tankBlue_barrel2.png": { "frame": { "x": 545, "y": 302, "w": 8, "h": 26 } },
                "tankBlue_barrel2_outline.png": { "frame": { "x": 542, "y": 48, "w": 12, "h": 30 } },
                "tankBlue_barrel3.png": { "frame": { "x": 545, "y": 519, "w": 8, "h": 26 } },
                "tankBlue_barrel3_outline.png": { "frame": { "x": 543, "y": 459, "w": 12, "h": 30 } },
                "tankBody_bigRed.png": { "frame": { "x": 384, "y": 56, "w": 48, "h": 48 } },
                "tankBody_bigRed_outline.png": { "frame": { "x": 106, "y": 512, "w": 52, "h": 52 } },
                "tankBody_blue.png": { "frame": { "x": 396, "y": 527, "w": 38, "h": 38 } },
                "tankBody_blue_outline.png": { "frame": { "x": 426, "y": 149, "w": 42, "h": 42 } },
                "tankBody_dark.png": { "frame": { "x": 468, "y": 149, "w": 38, "h": 36 } },
                "tankBody_darkLarge.png": { "frame": { "x": 384, "y": 0, "w": 48, "h": 56 } },
                "tankBody_darkLarge_outline.png": { "frame": { "x": 382, "y": 311, "w": 52, "h": 60 } },
                "tankBody_dark_outline.png": { "frame": { "x": 384, "y": 149, "w": 42, "h": 40 } },
                "tankBody_green.png": { "frame": { "x": 476, "y": 283, "w": 38, "h": 36 } },
                "tankBody_green_outline.png": { "frame": { "x": 435, "y": 191, "w": 42, "h": 40 } },
                "tankBody_huge.png": { "frame": { "x": 380, "y": 403, "w": 58, "h": 68 } },
                "tankBody_huge_outline.png": { "frame": { "x": 320, "y": 331, "w": 62, "h": 72 } },
                "tankBody_red.png": { "frame": { "x": 479, "y": 407, "w": 34, "h": 36 } },
                "tankBody_red_outline.png": { "frame": { "x": 476, "y": 0, "w": 38, "h": 40 } },
                "tankBody_sand.png": { "frame": { "x": 476, "y": 94, "w": 38, "h": 36 } },
                "tankBody_sand_outline.png": { "frame": { "x": 437, "y": 517, "w": 42, "h": 40 } },
                "tankDark_barrel1.png": { "frame": { "x": 543, "y": 342, "w": 12, "h": 26 } },
                "tankDark_barrel1_outline.png": { "frame": { "x": 514, "y": 68, "w": 16, "h": 30 } },
                "tankDark_barrel2.png": { "frame": { "x": 545, "y": 398, "w": 8, "h": 26 } },
                "tankDark_barrel2_outline.png": { "frame": { "x": 531, "y": 373, "w": 12, "h": 30 } },
                "tankDark_barrel3.png": { "frame": { "x": 553, "y": 519, "w": 8, "h": 26 } },
                "tankDark_barrel3_outline.png": { "frame": { "x": 543, "y": 429, "w": 12, "h": 30 } },
                "tankGreen_barrel1.png": { "frame": { "x": 533, "y": 403, "w": 12, "h": 26 } },
                "tankGreen_barrel1_outline.png": { "frame": { "x": 515, "y": 377, "w": 16, "h": 30 } },
                "tankGreen_barrel2.png": { "frame": { "x": 553, "y": 398, "w": 8, "h": 26 } },
                "tankGreen_barrel2_outline.png": { "frame": { "x": 530, "y": 98, "w": 12, "h": 30 } },
                "tankGreen_barrel3.png": { "frame": { "x": 552, "y": 276, "w": 8, "h": 26 } },
                "tankGreen_barrel3_outline.png": { "frame": { "x": 531, "y": 487, "w": 12, "h": 30 } },
                "tankRed_barrel1.png": { "frame": { "x": 531, "y": 347, "w": 12, "h": 26 } },
                "tankRed_barrel1_outline.png": { "frame": { "x": 514, "y": 0, "w": 16, "h": 30 } },
                "tankRed_barrel2.png": { "frame": { "x": 546, "y": 212, "w": 8, "h": 26 } },
                "tankRed_barrel2_outline.png": { "frame": { "x": 543, "y": 368, "w": 12, "h": 30 } },
                "tankRed_barrel3.png": { "frame": { "x": 553, "y": 302, "w": 8, "h": 26 } },
                "tankRed_barrel3_outline.png": { "frame": { "x": 532, "y": 128, "w": 12, "h": 30 } },
                "tankSand_barrel1.png": { "frame": { "x": 532, "y": 22, "w": 12, "h": 26 } },
                "tankSand_barrel1_outline.png": { "frame": { "x": 515, "y": 347, "w": 16, "h": 30 } },
                "tankSand_barrel2.png": { "frame": { "x": 546, "y": 186, "w": 8, "h": 26 } },
                "tankSand_barrel2_outline.png": { "frame": { "x": 542, "y": 78, "w": 12, "h": 30 } },
                "tankSand_barrel3.png": { "frame": { "x": 552, "y": 0, "w": 8, "h": 26 } },
                "tankSand_barrel3_outline.png": { "frame": { "x": 543, "y": 489, "w": 12, "h": 30 } },
                "tank_bigRed.png": { "frame": { "x": 210, "y": 512, "w": 52, "h": 52 } },
                "tank_blue.png": { "frame": { "x": 432, "y": 48, "w": 42, "h": 46 } },
                "tank_dark.png": { "frame": { "x": 434, "y": 311, "w": 42, "h": 46 } },
                "tank_darkLarge.png": { "frame": { "x": 383, "y": 192, "w": 52, "h": 60 } },
                "tank_green.png": { "frame": { "x": 434, "y": 357, "w": 42, "h": 46 } },
                "tank_huge.png": { "frame": { "x": 320, "y": 255, "w": 62, "h": 76 } },
                "tank_red.png": { "frame": { "x": 474, "y": 48, "w": 38, "h": 46 } },
                "tank_sand.png": { "frame": { "x": 437, "y": 471, "w": 42, "h": 46 } },
                "tileGrass1.png": { "frame": { "x": 192, "y": 384, "w": 64, "h": 64 } },
                "tileGrass2.png": { "frame": { "x": 192, "y": 320, "w": 64, "h": 64 } },
                "tileGrass_roadCornerLL.png": { "frame": { "x": 64, "y": 320, "w": 64, "h": 64 } },
                "tileGrass_roadCornerLR.png": { "frame": { "x": 64, "y": 384, "w": 64, "h": 64 } },
                "tileGrass_roadCornerUL.png": { "frame": { "x": 0, "y": 64, "w": 64, "h": 64 } },
                "tileGrass_roadCornerUR.png": { "frame": { "x": 192, "y": 256, "w": 64, "h": 64 } },
                "tileGrass_roadCrossing.png": { "frame": { "x": 0, "y": 319, "w": 64, "h": 64 } },
                "tileGrass_roadCrossingRound.png": { "frame": { "x": 64, "y": 0, "w": 64, "h": 64 } },
                "tileGrass_roadEast.png": { "frame": { "x": 64, "y": 128, "w": 64, "h": 64 } },
                "tileGrass_roadNorth.png": { "frame": { "x": 192, "y": 192, "w": 64, "h": 64 } },
                "tileGrass_roadSplitE.png": { "frame": { "x": 192, "y": 64, "w": 64, "h": 64 } },
                "tileGrass_roadSplitN.png": { "frame": { "x": 192, "y": 128, "w": 64, "h": 64 } },
                "tileGrass_roadSplitS.png": { "frame": { "x": 64, "y": 64, "w": 64, "h": 64 } },
                "tileGrass_roadSplitW.png": { "frame": { "x": 64, "y": 256, "w": 64, "h": 64 } },
                "tileGrass_roadTransitionE.png": { "frame": { "x": 192, "y": 0, "w": 64, "h": 64 } },
                "tileGrass_roadTransitionE_dirt.png": { "frame": { "x": 320, "y": 64, "w": 64, "h": 64 } },
                "tileGrass_roadTransitionN.png": { "frame": { "x": 320, "y": 0, "w": 64, "h": 64 } },
                "tileGrass_roadTransitionN_dirt.png": { "frame": { "x": 256, "y": 448, "w": 64, "h": 64 } },
                "tileGrass_roadTransitionS.png": { "frame": { "x": 256, "y": 384, "w": 64, "h": 64 } },
                "tileGrass_roadTransitionS_dirt.png": { "frame": { "x": 256, "y": 320, "w": 64, "h": 64 } },
                "tileGrass_roadTransitionW.png": { "frame": { "x": 256, "y": 256, "w": 64, "h": 64 } },
                "tileGrass_roadTransitionW_dirt.png": { "frame": { "x": 256, "y": 192, "w": 64, "h": 64 } },
                "tileGrass_transitionE.png": { "frame": { "x": 256, "y": 128, "w": 64, "h": 64 } },
                "tileGrass_transitionN.png": { "frame": { "x": 256, "y": 64, "w": 64, "h": 64 } },
                "tileGrass_transitionS.png": { "frame": { "x": 256, "y": 0, "w": 64, "h": 64 } },
                "tileGrass_transitionW.png": { "frame": { "x": 192, "y": 448, "w": 64, "h": 64 } },
                "tileSand1.png": { "frame": { "x": 128, "y": 0, "w": 64, "h": 64 } },
                "tileSand2.png": { "frame": { "x": 64, "y": 448, "w": 64, "h": 64 } },
                "tileSand_roadCornerLL.png": { "frame": { "x": 0, "y": 255, "w": 64, "h": 64 } },
                "tileSand_roadCornerLR.png": { "frame": { "x": 0, "y": 191, "w": 64, "h": 64 } },
                "tileSand_roadCornerUL.png": { "frame": { "x": 0, "y": 0, "w": 64, "h": 64 } },
                "tileSand_roadCornerUR.png": { "frame": { "x": 0, "y": 383, "w": 64, "h": 64 } },
                "tileSand_roadCrossing.png": { "frame": { "x": 320, "y": 128, "w": 64, "h": 64 } },
                "tileSand_roadCrossingRound.png": { "frame": { "x": 128, "y": 448, "w": 64, "h": 64 } },
                "tileSand_roadEast.png": { "frame": { "x": 128, "y": 384, "w": 64, "h": 64 } },
                "tileSand_roadNorth.png": { "frame": { "x": 128, "y": 320, "w": 64, "h": 64 } },
                "tileSand_roadSplitE.png": { "frame": { "x": 128, "y": 256, "w": 64, "h": 64 } },
                "tileSand_roadSplitN.png": { "frame": { "x": 128, "y": 192, "w": 64, "h": 64 } },
                "tileSand_roadSplitS.png": { "frame": { "x": 128, "y": 128, "w": 64, "h": 64 } },
                "tileSand_roadSplitW.png": { "frame": { "x": 128, "y": 64, "w": 64, "h": 64 } },
                "tracksDouble.png": { "frame": { "x": 438, "y": 403, "w": 41, "h": 52 } },
                "tracksLarge.png": { "frame": { "x": 439, "y": 231, "w": 41, "h": 52 } },
                "tracksSmall.png": { "frame": { "x": 476, "y": 319, "w": 37, "h": 52 } },
                "treeBrown_large.png": { "frame": { "x": 64, "y": 192, "w": 64, "h": 64 } },
                "treeBrown_leaf.png": { "frame": { "x": 312, "y": 512, "w": 8, "h": 10 } },
                "treeBrown_small.png": { "frame": { "x": 479, "y": 371, "w": 36, "h": 36 } },
                "treeBrown_twigs.png": { "frame": { "x": 506, "y": 130, "w": 26, "h": 22 } },
                "treeGreen_large.png": { "frame": { "x": 0, "y": 447, "w": 64, "h": 64 } },
                "treeGreen_leaf.png": { "frame": { "x": 328, "y": 555, "w": 8, "h": 10 } },
                "treeGreen_small.png": { "frame": { "x": 477, "y": 185, "w": 36, "h": 36 } },
                "treeGreen_twigs.png": { "frame": { "x": 506, "y": 152, "w": 26, "h": 22 } },
                "wireCrooked.png": { "frame": { "x": 432, "y": 0, "w": 44, "h": 48 } },
                "wireStraight.png": { "frame": { "x": 529, "y": 174, "w": 17, "h": 70 } }
            }
        };

        const config = {
            type: Phaser.AUTO,
            scale: {
                mode: Phaser.Scale.FIT,
                autoCenter: Phaser.Scale.CENTER_BOTH,
                width: window.innerWidth,
                height: window.innerHeight,
            },
            parent: 'game-container',
            physics: {
                default: 'arcade',
                arcade: {
                    debug: false,
                    gravity: { y: 0 }
                }
            },
            plugins: {
                global: [{
                    key: 'rexVirtualJoystick',
                    plugin: rexvirtualjoystickplugin,
                    start: true
                }],
            },

            scene: {
                preload: preload,
                create: create,
                update: update
            }
        };

        const game = new Phaser.Game(config);

        let player;
        let cursors;
        let bullets;
        let obstacles;
        let hazards;
        let sentries = [];
        let sentryHulls;
        let objective;
        let extractionZone;
        let isObjectiveCollected = false;
        let isMissionComplete = false;
        let rayGraphics;
        let leftStick;
        let rightStick;
        let debugGraphics;
        let mines;
        let isFireButtonDown = false;
        let manualFireRequested = false;
        const POWERUPS = {
            CANNON: {
                RAPID_FIRE: { id: 'RAPID_FIRE', name: 'Rapid Fire', desc: 'Significantly increases fire rate.', type: 'CANNON' },
                MULTI_SHOT: { id: 'MULTI_SHOT', name: 'Multi-Shot', desc: 'Fires 3 rounds at once in a spread.', type: 'CANNON' },
                POWER_SHOT: { id: 'POWER_SHOT', name: 'Power Shot', desc: 'Larger rounds that ignore obstacles.', type: 'CANNON' },
                LAND_MINE: {
                    id: 'LAND_MINE', name: 'Land Mine', desc: 'Drop explosive mines behind you.', type: 'CANNON'
                },
                FLAME_THROWER: {
                    id: 'FLAME_THROWER', name: 'Flame Thrower', desc: 'Short range fire that destroys enemy bullets.',
                    type: 'CANNON'
                }
            },
            CLOAK: {
                SCRAMBLE: {
                    id: 'SCRAMBLE', name: 'Scramble', desc: 'Enemies drive erratically and cannot target you.', type:
                        'CLOAK'
                },
                INVISIBLE: { id: 'INVISIBLE', name: 'Invisible', desc: 'Become nearly invisible and undetectable.', type: 'CLOAK' },
                DECOY: { id: 'DECOY', name: 'Decoy', desc: 'Deploys a noisy decoy to attract enemies.', type: 'CLOAK' },
                SHIELD: { id: 'SHIELD', name: 'Shield', desc: 'Absorbs one hit from any source.', type: 'CLOAK' },
                DISGUISE: { id: 'DISGUISE', name: 'Disguise', desc: 'Look like an enemy tank. Undetectable.', type: 'CLOAK' }
            }
        };

        const CANNON_KEYS = Object.keys(POWERUPS.CANNON);
        const CLOAK_KEYS = Object.keys(POWERUPS.CLOAK);

        let activePowerup = null;
        let inventory = Array(10).fill(null);
        let usedPowerups = new Set();
        let currentSelectionOptions = [];
        let isPowerupSelectionActive = false;

        let currentLevel = 1;

        class Bullet extends Phaser.Physics.Arcade.Sprite {
            constructor(scene, x, y) {
                super(scene, x, y, 'tanks', 'bulletBlue3.png');
                this.bounceCount = 0;
                this.isPlayerBullet = false;
                this.isPowerShot = false;
                this.isPowerShot = false;
                this.isFlame = false;
            }

            fire(x, y, rotation, isPlayerBullet, options = {}) {
                this.body.reset(x, y);
                this.setActive(true);
                this.setVisible(true);
                this.setRotation(rotation);
                this.isPlayerBullet = isPlayerBullet;
                this.isPowerShot = options.powerShot || false;
                this.isFlame = options.flame || false;

                let tex = isPlayerBullet ? 'bulletBlue3.png' : 'bulletRed3.png';
                if (this.isFlame) tex = 'shotOrange.png';
                if (this.isPowerShot) tex = 'bulletBlue2_outline.png';

                this.setFrame(tex);

                let speed = 400;
                if (this.isPowerShot) speed = 600;
                if (this.isFlame) speed = 300;

                const vec = new Phaser.Math.Vector2();
                vec.setToPolar(rotation - Math.PI / 2, 40);
                this.setPosition(x + vec.x, y + vec.y);

                this.scene.physics.velocityFromRotation(rotation - Math.PI / 2, speed, this.body.velocity);
                this.bounceCount = 0;

                if (this.isFlame) {
                    this.scene.time.delayedCall(500, () => {
                        if (this.active) this.reset();
                    });
                }
            }

            update(time, delta) {

            } reset() {
                this.setActive(false); this.setVisible(false); this.body.stop();
                this.isPowerShot = false; this.isFlame = false;
            }
        } class Tank {
            constructor(scene, x, y, textureBody, textureBarrel, trackTexture) {
                this.scene = scene;
                this.x = x;
                this.y = y;
                this.hull = scene.physics.add.sprite(x, y, 'tanks', textureBody);
                this.hull.setDrag(100);
                this.hull.setAngularDrag(100);
                this.hull.setMaxVelocity(200);
                this.hull.setCollideWorldBounds(true);
                this.turret = scene.add.sprite(x, y, 'tanks', textureBarrel);
                this.turret.setOrigin(0.5, 0.7);
                this.lastFired = 0;
                this.active = true;
                this.trackTexture = trackTexture;
                this.lastTrackPos = { x: x, y: y };
            }

            update() {
                if (!this.active) return;
                this.turret.x = this.hull.x;
                this.turret.y = this.hull.y;

                if (this.trackTexture && this.scene.tracks) {
                    const dist = Phaser.Math.Distance.Between(this.hull.x, this.hull.y, this.lastTrackPos.x, this.lastTrackPos.y);
                    if (dist > 30) {
                        const track = this.scene.tracks.create(this.hull.x, this.hull.y, 'tanks', this.trackTexture);
                        track.setRotation(this.hull.rotation);
                        track.setDepth(0);
                        track.setAlpha(0.5);
                        track.creationTime = this.scene.time.now;
                        this.lastTrackPos = { x: this.hull.x, y: this.hull.y };
                    }
                }
            } destroy() {
                this.hull.destroy(); this.turret.destroy();
                this.active = false;
            }
        } class PlayerTank extends Tank {
            constructor(scene, x, y) {
                super(scene, x, y, 'tankBody_blue_outline.png', 'tankBlue_barrel1_outline.png', 'tracksDouble.png');
                this.speed = 150;
            } update(time, cursors,
                pointer) {
                if (!this.active) return; if (activePowerup && time > activePowerup.endTime) {
                    activePowerup = null;
                    updateHUD();

                    this.hull.setAlpha(1);
                    this.turret.setAlpha(1);
                    this.isDisguised = false;
                    this.hull.setTexture('tanks', 'tankBody_blue_outline.png');
                    this.turret.setTexture('tanks', 'tankBlue_barrel1_outline.png');
                    this.isShielded = false;
                    if (this.shieldInfo) this.shieldInfo.clear();
                }

                if (this.isShielded && this.shieldInfo) {
                    this.shieldInfo.clear();
                    this.shieldInfo.lineStyle(2, 0x00ffff, 1);
                    this.shieldInfo.strokeCircle(this.hull.x, this.hull.y, 40);
                }

                super.update();

                this.hull.setVelocity(0);

                const velocity = new Phaser.Math.Vector2();

                if (cursors.left.isDown || cursors.a.isDown) {
                    velocity.x -= 1;
                } else if (cursors.right.isDown || cursors.d.isDown) {
                    velocity.x += 1;
                }

                if (cursors.up.isDown || cursors.w.isDown) {
                    velocity.y -= 1;
                } else if (cursors.down.isDown || cursors.s.isDown) {
                    velocity.y += 1;
                }

                const terrainMultiplier = this.scene.getTerrainSpeedMultiplier ?
                    this.scene.getTerrainSpeedMultiplier(this.hull.x, this.hull.y) : 1;
                const currentSpeed = this.speed * terrainMultiplier;

                if (velocity.length() === 0 && leftStick && leftStick.force > 0) {
                    this.scene.physics.velocityFromRotation(leftStick.rotation, leftStick.force * currentSpeed, velocity);
                } else if (velocity.length() > 0) {
                    velocity.normalize().scale(currentSpeed);
                }

                if (velocity.length() > 0) {
                    this.hull.setVelocity(velocity.x, velocity.y);

                    const angle = velocity.angle();
                    this.hull.rotation = Phaser.Math.Angle.RotateTo(this.hull.rotation, angle + Math.PI / 2, 0.1);
                }

                let targetAngle = this.turret.rotation - Math.PI / 2;
                let shouldFire = false;

                if (this.scene.sys.game.device.os.desktop) {
                    targetAngle = Phaser.Math.Angle.Between(this.hull.x, this.hull.y, pointer.worldX, pointer.worldY);
                    shouldFire = pointer.isDown;
                } else {
                    if (rightStick && rightStick.force > 0) {
                        const touchDuration = Date.now() - (rightStick.clickStartTime || 0);
                        if (touchDuration > 200) {
                            targetAngle = rightStick.rotation;
                        }
                    }
                    if (manualFireRequested) {
                        shouldFire = true;
                        manualFireRequested = false;
                    }
                }

                this.turret.rotation = targetAngle + Math.PI / 2;

                if (shouldFire && time > this.lastFired) {
                    let fireDelay = 1500;
                    let isRapid = false;
                    let isMulti = false;
                    let isPower = false;
                    let isFlame = false;

                    if (activePowerup && activePowerup.type.type === 'CANNON') {
                        const pid = activePowerup.type.id;
                        if (pid === 'RAPID_FIRE') { isRapid = true; fireDelay = 150; }
                        if (pid === 'MULTI_SHOT') isMulti = true;
                        if (pid === 'POWER_SHOT') { isPower = true; fireDelay = 500; }
                        if (pid === 'FLAME_THROWER') { isFlame = true; fireDelay = 100; }
                    } else if (activePowerup && activePowerup.type.type === 'CLOAK') {
                        activePowerup.endTime = time;
                        activePowerup = null;
                        updateHUD();
                        this.hull.setAlpha(1);
                        this.turret.setAlpha(1);
                        this.isDisguised = false;
                        this.hull.setTexture('tanks', 'tankBody_blue_outline.png');
                        this.turret.setTexture('tanks', 'tankBlue_barrel1_outline.png');
                        this.isShielded = false;
                        if (this.shieldInfo) this.shieldInfo.clear();
                    }

                    const bulletOptions = { powerShot: isPower, flame: isFlame };

                    if (activePowerup && activePowerup.type.id === 'LAND_MINE') {
                        const mine = mines.create(this.hull.x, this.hull.y, 'tanks', 'barrelRed_top.png');
                        mine.setDepth(5);
                        this.lastFired = time + 2000;
                        return;
                    }

                    if (isMulti) {
                        const offsets = [-0.2, 0, 0.2];
                        offsets.forEach(off => {
                            const b = bullets.get();
                            if (b) b.fire(this.hull.x, this.hull.y, this.turret.rotation + off, true, bulletOptions);
                        });
                    } else {
                        const bullet = bullets.get();
                        if (bullet) {
                            bullet.fire(this.hull.x, this.hull.y, this.turret.rotation, true, bulletOptions);
                        }
                    }

                    this.lastFired = time + fireDelay;

                    sentries.forEach(sentry => {
                        if (sentry.active) {
                            const dist = Phaser.Math.Distance.Between(this.hull.x, this.hull.y, sentry.hull.x, sentry.hull.y);
                            if (dist < 600) {
                                sentry.state = 'CHASE'; sentry.lastKnownPosition = { x: this.hull.x, y: this.hull.y };
                                sentry.alertUI();
                            }
                        }
                    });
                }
            }
        }

        class SentryTank extends Tank {
            constructor(scene, path) {
                super(scene, path[0].x, path[0].y, 'tankBody_darkLarge_outline.png', 'tankDark_barrel1_outline.png', 'tracksLarge.png');
                this.patrolPath = path;
                this.patrolIndex = 0;
                this.speed = 80;
                this.visionRange = 250;
                this.visionAngle = Phaser.Math.DegToRad(45);
                this.state = 'PATROL';
                this.alertTimer = 0;
                this.lastKnownPosition = null;
                this.hull.setData('parent', this);
                this.rayLength = 100;
            }

            update(time, player) {
                if (!this.active) return;
                super.update();

                if (isMissionComplete) return;

                if (isObjectiveCollected && this.state !== 'CHASE' && this.state !== 'ALERT' && this.state !== 'STUCK') {
                    this.state = 'CHASE';
                }

                switch (this.state) {
                    case 'PATROL':
                        this.patrolBehavior(time);
                        if (this.canSeePlayer(player)) {
                            this.state = 'CHASE';
                            this.lastKnownPosition = { x: player.hull.x, y: player.hull.y };
                            this.alertUI();
                        } else {
                            this.scanForTracks();
                        }
                        break;
                    case 'CHASE':
                        this.chaseBehavior(time, player);
                        break;
                    case 'STUCK':
                        this.stuckBehavior(time);
                        break;
                }
            }

            patrolBehavior(time) {
                const target = this.patrolPath[this.patrolIndex];

                this.navigateToward(target, time);

                const dist = Phaser.Math.Distance.Between(this.hull.x, this.hull.y, target.x, target.y);
                if (dist < 20) {
                    this.patrolIndex = (this.patrolIndex + 1) % this.patrolPath.length;
                }
            }

            stuckBehavior(time) {
                if (time > this.stuckEndTime) {
                    this.state = this.previousState || 'CHASE';
                    this.lastPosCheck = { x: this.hull.x, y: this.hull.y, time: time };
                    return;
                }

                const velocity = this.scene.physics.velocityFromRotation(this.hull.rotation, -50);
                this.hull.setVelocity(velocity.x, velocity.y);
                this.hull.rotation += 0.05;
            }

            chaseBehavior(time, player) {
                if (activePowerup && activePowerup.type.id === 'SCRAMBLE') {
                    if (Math.random() < 0.05) {
                        const randAngle = Math.random() * Math.PI * 2;
                        const velocity = this.scene.physics.velocityFromRotation(randAngle, this.speed);
                        this.hull.setVelocity(velocity.x, velocity.y);
                        this.hull.rotation = randAngle + Math.PI / 2;
                        this.turret.rotation = Math.random() * Math.PI * 2;
                    }
                    if (time > this.lastFired && Math.random() < 0.1) {
                        const bullet = bullets.get();
                        if (bullet) {
                            bullet.fire(this.hull.x, this.hull.y, this.turret.rotation, false);
                            this.lastFired = time + 500;
                        }
                    }
                    return;
                }

                if (isObjectiveCollected) {
                    this.lastKnownPosition = { x: player.hull.x, y: player.hull.y };
                }

                let target = player.hull;

                if (this.scene.decoys && this.scene.decoys.length > 0) {
                    let nearestDecoy = null;
                    let minDist = 10000;
                    this.scene.decoys.forEach(d => {
                        if (d.active) {
                            const dist = Phaser.Math.Distance.Between(this.hull.x, this.hull.y, d.x, d.y);
                            if (dist < minDist) {
                                minDist = dist;
                                nearestDecoy = d;
                            }
                        }
                    });

                    if (nearestDecoy && minDist < this.visionRange * 1.5) {
                        target = nearestDecoy;
                    }
                }

                if (!player.active && !target.active) return;

                if (target === player.hull) {
                    if (this.canSeePlayer(player)) {
                        this.lastKnownPosition = { x: player.hull.x, y: player.hull.y };
                    } else {
                        if (this.lastKnownPosition) {
                            const dist = Phaser.Math.Distance.Between(this.hull.x, this.hull.y, this.lastKnownPosition.x, this.lastKnownPosition.y);
                            if (dist < 50) {
                                this.lastKnownPosition = null;
                                this.state = 'PATROL';
                                return;
                            }
                            this.navigateToward(this.lastKnownPosition, time);
                            const angle = this.hull.body.velocity.angle();
                            this.turret.rotation = Phaser.Math.Angle.RotateTo(this.turret.rotation, angle + Math.PI / 2, 0.1);
                            return;
                        } else {
                            this.state = 'PATROL';
                            return;
                        }
                    }
                }

                this.navigateToward({ x: target.x, y: target.y }, time);

                const angle = Phaser.Math.Angle.Between(this.hull.x, this.hull.y, target.x, target.y);
                this.turret.rotation = angle + Math.PI / 2;

                const facingAngle = this.hull.rotation - Math.PI / 2;
                const turretAngle = this.turret.rotation - Math.PI / 2;
                const diff = Phaser.Math.Angle.Wrap(angle - turretAngle);

                if (Math.abs(diff) < 0.2 && time > this.lastFired) {
                    const bullet = bullets.get();
                    if (bullet) {
                        bullet.fire(this.hull.x, this.hull.y, this.turret.rotation, false);
                        this.lastFired = time + 1500;
                    }
                }
            }

            navigateToward(targetPos, time) {
                if (!this.lastPosCheck) {
                    this.lastPosCheck = { x: this.hull.x, y: this.hull.y, time: time };
                }
                if (time > this.lastPosCheck.time + 1000) {
                    const distMoved = Phaser.Math.Distance.Between(this.hull.x, this.hull.y, this.lastPosCheck.x, this.lastPosCheck.y);
                    if (distMoved < 10) {
                        this.previousState = this.state;
                        this.state = 'STUCK';
                        this.stuckEndTime = time + 1000;
                    }
                    this.lastPosCheck = { x: this.hull.x, y: this.hull.y, time: time };
                }

                const angleToTarget = Phaser.Math.Angle.Between(this.hull.x, this.hull.y, targetPos.x, targetPos.y);
                let moveAngle = angleToTarget;

                const startPoint = new Phaser.Math.Vector2(this.hull.x, this.hull.y);
                const forwardVec = new Phaser.Math.Vector2().setToPolar(this.hull.rotation - Math.PI / 2, this.rayLength);
                const forwardRay = new Phaser.Geom.Line(startPoint.x, startPoint.y, startPoint.x + forwardVec.x, startPoint.y + forwardVec.y);

                let blocked = false;
                const obs = obstacles.getChildren();

                for (let i = 0; i < obs.length; i++) {
                    if (Phaser.Geom.Intersects.LineToRectangle(forwardRay, obs[i].body)) {
                        blocked = true;
                        break;
                    }
                }

                if (blocked) {
                    const leftVec = new Phaser.Math.Vector2().setToPolar(this.hull.rotation - Math.PI / 2 - 0.7, this.rayLength);
                    const rightVec = new Phaser.Math.Vector2().setToPolar(this.hull.rotation - Math.PI / 2 + 0.7, this.rayLength);

                    const leftRay = new Phaser.Geom.Line(startPoint.x, startPoint.y, startPoint.x + leftVec.x, startPoint.y + leftVec.y);
                    const rightRay = new Phaser.Geom.Line(startPoint.x, startPoint.y, startPoint.x + rightVec.x, startPoint.y + rightVec.y);

                    let leftBlocked = false;
                    let rightBlocked = false;

                    for (let i = 0; i < obs.length; i++) {
                        if (Phaser.Geom.Intersects.LineToRectangle(leftRay, obs[i].body)) leftBlocked = true;
                        if (Phaser.Geom.Intersects.LineToRectangle(rightRay, obs[i].body)) rightBlocked = true;
                    }

                    if (leftBlocked && !rightBlocked) {
                        moveAngle += 1.2;
                    } else if (rightBlocked && !leftBlocked) {
                        moveAngle -= 1.2;
                    } else if (leftBlocked && rightBlocked) {
                        moveAngle += Math.PI;
                    } else {
                        const diff = Phaser.Math.Angle.Wrap(angleToTarget - (this.hull.rotation - Math.PI / 2));
                        moveAngle += (diff > 0 ? 1.0 : -1.0);
                    }
                }

                const terrainMultiplier = this.scene.getTerrainSpeedMultiplier ? this.scene.getTerrainSpeedMultiplier(this.hull.x, this.hull.y) : 1;
                const currentSpeed = this.speed * terrainMultiplier;

                const velocity = this.scene.physics.velocityFromRotation(moveAngle, currentSpeed);
                this.hull.setVelocity(velocity.x, velocity.y);

                const desiredRotation = moveAngle + Math.PI / 2;
                this.hull.rotation = Phaser.Math.Angle.RotateTo(this.hull.rotation, desiredRotation, 0.1);

                if (this.state === 'PATROL') this.turret.rotation = this.hull.rotation;
            }

            scanForTracks() {
                if (!this.scene.tracks) return;

                let freshestTrack = null;
                let maxTime = 0;

                this.scene.tracks.children.each(track => {
                    const dist = Phaser.Math.Distance.Between(this.hull.x, this.hull.y, track.x, track.y);
                    if (dist < this.visionRange) {
                        const angleToTrack = Phaser.Math.Angle.Between(this.hull.x, this.hull.y, track.x, track.y);
                        const facingAngle = this.turret.rotation - Math.PI / 2;
                        let diff = Phaser.Math.Angle.Wrap(angleToTrack - facingAngle);

                        if (Math.abs(diff) < this.visionAngle / 2) {
                            const line = new Phaser.Geom.Line(this.hull.x, this.hull.y, track.x, track.y);
                            let blocked = false;
                            obstacles.getChildren().forEach(obs => {
                                if (Phaser.Geom.Intersects.LineToRectangle(line, obs.body)) blocked = true;
                            });

                            if (!blocked) {
                                if (track.creationTime > maxTime) {
                                    maxTime = track.creationTime;
                                    freshestTrack = track;
                                }
                            }
                        }
                    }
                });

                if (freshestTrack) {
                    this.state = 'CHASE';
                    this.lastKnownPosition = { x: freshestTrack.x, y: freshestTrack.y };
                }
            }

            canSeePlayer(player) {
                if (!player.active) return false;

                if (player.isDisguised) return false;
                if (activePowerup && activePowerup.type.id === 'INVISIBLE') return false;

                const dist = Phaser.Math.Distance.Between(this.hull.x, this.hull.y, player.hull.x, player.hull.y);
                if (dist > this.visionRange) return false;

                const angleToPlayer = Phaser.Math.Angle.Between(this.hull.x, this.hull.y, player.hull.x, player.hull.y);
                const facingAngle = this.turret.rotation - Math.PI / 2;
                let diff = Phaser.Math.Angle.Wrap(angleToPlayer - facingAngle);

                if (Math.abs(diff) < this.visionAngle / 2) {
                    const line = new Phaser.Geom.Line(this.hull.x, this.hull.y, player.hull.x, player.hull.y);
                    let blocked = false;
                    obstacles.getChildren().forEach(obs => {
                        if (Phaser.Geom.Intersects.LineToRectangle(line, obs.body)) blocked = true;
                    });
                    return !blocked;
                }
                return false;
            }

            alertUI() {
                const startColor = Phaser.Display.Color.ValueToColor(0xffffff);
                const endColor = Phaser.Display.Color.ValueToColor(0xff0000);
                this.scene.tweens.addCounter({
                    from: 0,
                    to: 100,
                    duration: 500,
                    onUpdate: tween => {
                        const value = tween.getValue();
                        const col = Phaser.Display.Color.Interpolate.ColorWithColor(startColor, endColor, 100, value);
                        this.turret.setTint(Phaser.Display.Color.GetColor(col.r, col.g, col.b));
                    }
                });
                document.querySelectorAll('.status-ok').forEach(el => {
                    el.className = 'status-alert';
                    el.innerText = 'DANGER';
                });
            }

            explode() {
                const particles = this.scene.add.particles(this.hull.x, this.hull.y, 'tanks', {
                    frame: 'explosion1.png',
                    speed: 50,
                    scale: { start: 1, end: 0 },
                    duration: 500,
                    maxParticles: 10
                });
                this.destroy();
            }
        }

        function preload() {
            this.load.image('tanks_sheet', ASSET_URL);
        }

        function create() {
            this.textures.addAtlas('tanks',
                this.textures.get('tanks_sheet').source[0].image, ATLAS_JSON);

            cursors = this.input.keyboard.createCursorKeys();
            cursors.w = this.input.keyboard.addKey(Phaser.Input.Keyboard.KeyCodes.W);
            cursors.a = this.input.keyboard.addKey(Phaser.Input.Keyboard.KeyCodes.A);
            cursors.s = this.input.keyboard.addKey(Phaser.Input.Keyboard.KeyCodes.S);
            cursors.d = this.input.keyboard.addKey(Phaser.Input.Keyboard.KeyCodes.D);

            const LEVEL_WIDTH = 1600;
            const LEVEL_HEIGHT = 1200;

            this.physics.world.setBounds(0, 0, LEVEL_WIDTH, LEVEL_HEIGHT);
            this.cameras.main.setBounds(0, 0, LEVEL_WIDTH, LEVEL_HEIGHT);

            this.tracks = this.add.group();

            this.tileGrid = [];
            const cols = Math.ceil(LEVEL_WIDTH / 64);
            const rows = Math.ceil(LEVEL_HEIGHT / 64);

            for (let y = 0; y < rows; y++) {
                this.tileGrid[y] = []; for (let x = 0; x < cols; x++) {
                    const
                        isSand = Math.random() < 0.3; const tileType = isSand ? (Math.random() < 0.5 ? 'tileSand1.png'
                            : 'tileSand2.png') : (Math.random() < 0.5 ? 'tileGrass1.png' : 'tileGrass2.png');
                    this.add.image(x * 64 + 32, y * 64 + 32, 'tanks', tileType).setTint(0x777777);
                    this.tileGrid[y][x] = isSand ? 'sand' : 'grass';
                }
            } this.getTerrainSpeedMultiplier = (x, y) => {
                const col = Math.floor(x / 64);
                const row = Math.floor(y / 64);
                if (row >= 0 && row < this.tileGrid.length && col >= 0 && col < this.tileGrid[0].length) {
                    return this.tileGrid[row][col] === 'sand' ? 0.6 : 1.0;
                } return 1.0;
            };
            obstacles = this.physics.add.staticGroup(); hazards = this.physics.add.staticGroup();
            bullets = this.physics.add.group({
                classType: Bullet, maxSize: 50, runChildUpdate:
                    false
            }); sentryHulls = this.physics.add.group(); sentries = [];
            this.physics.add.collider(bullets, obstacles, (bullet, obstacle) => {
                if (!bullet.active) return;

                if (bullet.isPowerShot) {
                    this.add.particles(obstacle.x, obstacle.y, 'tanks', {
                        frame: 'explosion1.png',
                        speed: 50,
                        scale: { start: 1, end: 0 },
                        duration: 500,
                        maxParticles: 10
                    });
                    obstacle.destroy();
                    obstacle.destroy();
                    return;
                }

                if (obstacle.frame.name.includes('crateWood')) {
                    obstacle.destroy();
                    bullet.reset();
                    return;
                }

                if (bullet.bounceCount < 1) {
                    bullet.bounceCount++; const body = bullet.body; if
                        (body.touching.up || body.touching.down) body.velocity.y *= -1; if
                        (body.touching.left || body.touching.right) body.velocity.x *= -1;
                    bullet.rotation = body.velocity.angle() + Math.PI / 2;
                } else {
                    bullet.reset(); if
                        (obstacle.texture.key === 'tanks' && obstacle.frame.name.includes('crate')) {
                        obstacle.destroy();
                    }
                }
            }, (bullet, obstacle) => {
                if (obstacle.frame.name === 'treeGreen_small.png') return false;
                return true;
            });


            rayGraphics = this.add.graphics();
            debugGraphics = this.add.graphics().setDepth(100);

            createMobileControls.call(this);

            this.input.keyboard.on('keydown', (event) => {
                if (event.key === '`' || event.key === '~') {
                    inventory.fill(null);
                    let idx = 0;
                    Object.values(POWERUPS.CANNON).forEach(p => { if (idx < 5) inventory[idx++] = p; });
                    idx = 5;
                    Object.values(POWERUPS.CLOAK).forEach(p => { if (idx < 10) inventory[idx++] = p; });
                    updateHUD();
                    return;
                }

                const key = parseInt(event.key);
                if (!isNaN(key)) {
                    const idx = (key === 0) ? 9 : key - 1;
                    activatePowerup.call(this, idx);
                }
            });

            startLevel.call(this, currentLevel);
        }

        function activatePowerup(index) {
            if (activePowerup) return;
            if (!inventory[index]) return;
            if (usedPowerups.has(index)) return;

            const p = inventory[index];
            activePowerup = {
                type: p,
                endTime: this.time.now + 10000,
                startTime: this.time.now
            };

            updateHUD();

            usedPowerups.add(index);
            updateHUD();

            if (player) {
                if (p.id === 'INVISIBLE') {
                    player.hull.setAlpha(0.2);
                    player.turret.setAlpha(0.2);
                } else if (p.id === 'DISGUISE') {
                    player.isDisguised = true;
                    player.hull.setTexture('tanks', 'tankBody_darkLarge.png');
                    player.turret.setTexture('tanks',
                        'tankDark_barrel1_outline.png');
                } else if (p.id === 'SHIELD') {
                    player.isShielded = true;
                    if (!player.shieldInfo) {
                        player.shieldInfo = this.add.graphics();
                    }
                } else if (p.id === 'DECOY') {
                    const decoy = this.add.sprite(player.hull.x, player.hull.y,
                        'tanks', 'tankBody_blue_outline.png');
                    decoy.turret = this.add.sprite(player.hull.x, player.hull.y,
                        'tanks', 'tankBlue_barrel1_outline.png');
                    decoy.turret.setOrigin(0.5, 0.7);
                    decoy.isDecoy = true;

                    if (!this.decoys) this.decoys = [];
                    this.decoys.push(decoy);

                    this.time.delayedCall(10000, () => {
                        if (decoy.active) {
                            decoy.destroy();
                            if (decoy.turret) decoy.turret.destroy();
                        }
                    });
                }
            }
        }

        function startLevel(levelNum) {
            currentLevel = levelNum;
            activePowerup = null;
            usedPowerups.clear();
            updateHUD();
            isMissionComplete = false;
            isObjectiveCollected = false;
            document.getElementById('mission-status').style.display =
                'block';
            document.getElementById('mission-status').innerText = 'LEVEL ' +
                levelNum + ' START';
            document.getElementById('mission-status').style.color =
                '#00d2ff';
            document.getElementById('mission-status').style.borderColor =
                '#00d2ff';

            this.time.delayedCall(2000, () => {
                if (!isMissionComplete)
                    document.getElementById('mission-status').style.display =
                        'none';
            });

            document.querySelectorAll('.status-alert').forEach(el => {
                el.className = 'status-ok';
                el.innerText = 'ACTIVE';
            });

            if (player) {
                player.destroy();
                player = null;
            }
            obstacles.clear(true, true);
            hazards.clear(true, true);
            bullets.clear(true, true);
            if (this.tracks) {
                this.tracks.clear(true, true);
            }
            if (sentries.length > 0) {
                sentries.forEach(s => s.destroy());
            }
            sentryHulls.clear(true, true);
            sentries = [];
            if (objective) objective.destroy();
            if (extractionZone) extractionZone.destroy();
            if (mines) mines.clear(true, true);

            const LEVEL_WIDTH = 1600;
            const LEVEL_HEIGHT = 1200;

            const TILE_SIZE = 64;
            const cols = Math.ceil(LEVEL_WIDTH / TILE_SIZE);
            const rows = Math.ceil(LEVEL_HEIGHT / TILE_SIZE);
            const grid = Array(rows).fill().map(() => Array(cols).fill(0));

            for (let y = 0; y < rows; y++) { grid[y][0] = 1; grid[y][cols - 1] = 1; } for (let
                x = 0; x < cols; x++) { grid[0][x] = 1; grid[rows - 1][x] = 1; } const
                    obstacleCount = 30 + (levelNum * 5); let obstaclesPlaced = 0; while
                (obstaclesPlaced < obstacleCount) {
                const c = Phaser.Math.Between(1, cols -
                    2); const r = Phaser.Math.Between(1, rows - 2); if (grid[r][c] === 0) {
                        grid[r][c] = 1; const x = c * TILE_SIZE + TILE_SIZE / 2; const y = r * TILE_SIZE +
                            TILE_SIZE / 2; const
                                type = Phaser.Math.RND.pick(['crateMetal.png', 'crateWood.png'
                                    , 'barrelRust_top.png', 'treeGreen_small.png']); obstacles.create(x,
                                        y, 'tanks', type).setTint(0x777777); obstaclesPlaced++;
                    }
            } const
                findSpawn = () => {
                    let attempts = 0;
                    while (attempts < 1000) {
                        const c = Phaser.Math.Between(1, cols - 2); const
                            r = Phaser.Math.Between(1, rows - 2); if (grid[r][c] === 0) {
                                return {
                                    x: c
                                        * TILE_SIZE + TILE_SIZE / 2, y: r * TILE_SIZE + TILE_SIZE / 2, c, r
                                };
                            }
                        attempts++;
                    } return { x: 200, y: 200 };
                }; const pSpawn = findSpawn();
            player = new PlayerTank(this, pSpawn.x, pSpawn.y);
            this.cameras.main.startFollow(player.hull); let oSpawn = findSpawn();
            while (Phaser.Math.Distance.Between(pSpawn.x, pSpawn.y, oSpawn.x,
                oSpawn.y) < 800) { oSpawn = findSpawn(); }
            objective = this.physics.add.image(oSpawn.x, oSpawn.y, 'tanks'
                , 'specialBarrel1_outline.png');
            extractionZone = this.add.rectangle(pSpawn.x, pSpawn.y, 120, 120,
                0x00ff00, 0.2); this.physics.add.existing(extractionZone, true); const
                    enemyCount = 2 + Math.floor(levelNum * 1.5); for (let i = 0; i < enemyCount;
                i++) {
                let eSpawn = findSpawn(); while
                    (Phaser.Math.Distance.Between(pSpawn.x, pSpawn.y, eSpawn.x, eSpawn.y) <
                    500) { eSpawn = findSpawn(); } const path = [{ x: eSpawn.x, y: eSpawn.y }];
                let p2 = findSpawn(); path.push({ x: p2.x, y: p2.y }); const s = new
                    SentryTank(this, path); sentries.push(s); sentryHulls.add(s.hull);
            }
            this.physics.add.collider(player.hull, obstacles);
            this.physics.add.collider(player.hull, sentryHulls);
            this.physics.add.collider(sentryHulls, obstacles);
            this.physics.add.overlap(bullets, player.hull, (hull, bullet) => {
                if (!bullet.active || bullet.isPlayerBullet) return;

                if (player.isShielded) {
                    bullet.reset();
                    player.isShielded = false;
                    if (player.shieldInfo) player.shieldInfo.clear();
                    if (activePowerup && activePowerup.type.id === 'SHIELD') {
                        activePowerup = null;
                        updateHUD();
                    }
                    return;
                }

                bullet.reset();
                player.destroy();
                document.getElementById('mission-status').style.display
                    = 'block';
                document.getElementById('mission-status').innerText =
                    'MISSION FAILED - RESTARTING...';
                document.getElementById('mission-status').style.color =
                    '#e74c3c';
                document.getElementById('mission-status').style.borderColor
                    = '#e74c3c';

                this.time.delayedCall(3000, () => {
                    startLevel.call(this, currentLevel);
                });
            });

            this.physics.add.overlap(bullets, bullets, (b1, b2) => {
                if (!b1.active || !b2.active) return;
                if (b1.isFlame && !b2.isPlayerBullet) {
                    b2.reset();
                } else if (b2.isFlame && !b1.isPlayerBullet) {
                    b1.reset();
                }
            });

            this.physics.add.overlap(bullets, sentryHulls, (bullet,
                hull) => {
                if (!bullet.active || !bullet.isPlayerBullet) return;
                bullet.reset();
                const sentry = hull.getData('parent');
                if (sentry && sentry.active) {
                    sentry.explode();
                }
            });

            mines = this.physics.add.group();
            this.physics.add.overlap(mines, sentryHulls, (mine, hull) => {
                const sentry = hull.getData('parent');
                if (sentry && sentry.active) {
                    mine.destroy();
                    sentry.explode();
                    const explosion = this.add.sprite(mine.x, mine.y, 'tanks', 'explosion1.png');
                    explosion.play('explode');
                    this.time.delayedCall(100, () => explosion.destroy());
                }
            });


            this.physics.add.overlap(player.hull, objective, () => {
                isObjectiveCollected = true;
                objective.destroy();
                document.getElementById('mission-status').style.display
                    = 'block';
                document.getElementById('mission-status').innerText =
                    'OBJECTIVE SECURED! RETURN TO EXTRACT!';
                document.getElementById('mission-status').style.color =
                    '#e67e22';
            });

            this.physics.add.overlap(player.hull, extractionZone, () => {
                if (isObjectiveCollected && !isMissionComplete) {
                    isMissionComplete = true;
                    player.hull.setVelocity(0);
                    player.hull.body.stop();
                    sentries.forEach(s => {
                        if (s.hull && s.hull.body) {
                            s.hull.setVelocity(0);
                            s.hull.body.stop();
                        }
                    });
                    document.getElementById('mission-status').innerText =
                        'MISSION ACCOMPLISHED!';
                    document.getElementById('mission-status').style.color =
                        '#2ecc71';

                    this.time.delayedCall(2000, () => {
                        showPowerupSelection.call(this);
                    });
                }
            });
        }

        const POWERUP_INDEX_MAP = {
            'RAPID_FIRE': 0,
            'MULTI_SHOT': 1,
            'POWER_SHOT': 2,
            'LAND_MINE': 3,
            'FLAME_THROWER': 4,
            'SCRAMBLE': 5,
            'INVISIBLE': 6,
            'DECOY': 7,
            'SHIELD': 8,
            'DISGUISE': 9
        };

        function updateHUD() {
            inventory.forEach((item, index) => {
                const slot = document.getElementById('slot-' + index);

                slot.innerHTML = '';
                slot.onclick = () => window.triggerPowerup(index);

                const keySpan = document.createElement('span');
                keySpan.className = 'slot-key';
                keySpan.innerText = (index + 1) % 10;
                slot.appendChild(keySpan);

                if (item) {
                    slot.classList.add('filled');
                    slot.classList.remove('active');
                    slot.style.cursor = 'pointer';

                    const nameSpan = document.createElement('span');
                    nameSpan.innerText = item.name.substring(0,
                        3).toUpperCase();
                    slot.appendChild(nameSpan);

                    if (usedPowerups.has(index)) {
                        slot.classList.add('used');
                        slot.style.cursor = 'not-allowed';
                    } else {
                        slot.classList.remove('used');
                    }

                } else {
                    slot.classList.remove('filled');
                    slot.classList.remove('active');
                    slot.classList.remove('used');
                    slot.style.cursor = 'default';
                }
            });

            if (activePowerup) {
                const idx = POWERUP_INDEX_MAP[activePowerup.type.id];
                const slot = document.getElementById('slot-' + idx);
                if (slot) {
                    slot.classList.add('active');
                    const bar = document.createElement('div');
                    bar.className = 'active-timer-bar';
                    bar.id = 'active-timer-bar';
                    slot.appendChild(bar);
                }
            }
        }

        function showPowerupSelection() {
            const cannonMissing = [];
            CANNON_KEYS.forEach(key => {
                const idx = POWERUP_INDEX_MAP[key];
                if (!inventory[idx])
                    cannonMissing.push(POWERUPS.CANNON[key]);
            });

            const cloakMissing = [];
            CLOAK_KEYS.forEach(key => {
                const idx = POWERUP_INDEX_MAP[key];
                if (!inventory[idx])
                    cloakMissing.push(POWERUPS.CLOAK[key]);
            });

            if (cannonMissing.length === 0 && cloakMissing.length
                === 0) {
                document.getElementById('mission-status').innerText =
                    'INVENTORY FULL - ADVANCING...';
                setTimeout(() => {
                    startLevel.call(this, currentLevel + 1);
                }, 2000);
                return;
            }

            currentSelectionOptions = [];


            if (cannonMissing.length > 0 && cloakMissing.length > 0) {
                const c = Phaser.Math.RND.pick(cannonMissing);
                const l = Phaser.Math.RND.pick(cloakMissing);
                currentSelectionOptions = [c, l];
                if (Math.random() > 0.5)
                    currentSelectionOptions.reverse();
            } else if (cannonMissing.length === 0) {
                Phaser.Utils.Array.Shuffle(cloakMissing);
                currentSelectionOptions = cloakMissing.slice(0, 2);
            } else {
                Phaser.Utils.Array.Shuffle(cannonMissing);
                currentSelectionOptions = cannonMissing.slice(0, 2);
            }

            if (currentSelectionOptions.length === 0) {
                startLevel.call(this, currentLevel + 1);
                return;
            }

            const overlay =
                document.getElementById('powerup-selection-overlay');
            overlay.style.display = 'flex';

            const card1 = document.getElementById('option-1');
            const card2 = document.getElementById('option-2');

            setupCard(card1, currentSelectionOptions[0]);

            if (currentSelectionOptions.length > 1) {
                card2.style.display = 'block';
                setupCard(card2, currentSelectionOptions[1]);
            } else {
                card2.style.display = 'none';
            }

            isPowerupSelectionActive = true;
        }

        function setupCard(element, powerup) {
            const title = element.querySelector('.powerup-title');
            const desc = element.querySelector('.powerup-desc');

            title.innerText = powerup.name;
            title.className = 'powerup-title ' + (powerup.type ===
                'CANNON' ? 'powerup-type-cannon' :
                'powerup-type-cloak');
            desc.innerText = powerup.desc;
        }

        window.selectPowerup = function (optionIndex) {
            if (!isPowerupSelectionActive) return;
            if (!currentSelectionOptions[optionIndex]) return;

            const selected = currentSelectionOptions[optionIndex];
            const idx = POWERUP_INDEX_MAP[selected.id];

            inventory[idx] = selected;
            updateHUD();

            document.getElementById('powerup-selection-overlay').style.display
                = 'none';
            isPowerupSelectionActive = false;

            const scene = game.scene.scenes[0];
            startLevel.call(scene, currentLevel + 1);
        };

        window.triggerPowerup = function (index) {
            const scene = game.scene.scenes[0];
            if (scene) {
                activatePowerup.call(scene, index);
            }
        };


        function createMobileControls() {
            if (this.sys.game.device.os.desktop) return;

            const width = this.scale.width;
            const height = this.scale.height;

            let radius = 100;
            let baseX1 = 150;
            let baseX2 = width - 150;
            let baseY = height - 150;

            if (width < 600) {
                radius = 60; baseX1 = width * 0.25; baseX2 = width * 0.75;
                baseY = height - 100;
            }
            leftStick = this.plugins.get('rexVirtualJoystick').add(this, {
                x:
                    baseX1, y: baseY, radius: radius, base: this.add.circle(0, 0,
                        radius, 0x888888).setAlpha(0.5).setDepth(100), thumb:
                    this.add.circle(0, 0, radius * 0.5,
                        0xcccccc).setAlpha(0.8).setDepth(100), dir: '8dir', forceMin: 16,
                enable: true
            });
            rightStick = this.plugins.get('rexVirtualJoystick').add(this, {
                x:
                    baseX2, y: baseY, radius: radius, base: this.add.circle(0, 0,
                        radius, 0x888888).setAlpha(0.5).setDepth(100), thumb:
                    this.add.circle(0, 0, radius * 0.5,
                        0xcccccc).setAlpha(0.8).setDepth(100), dir: '8dir', forceMin: 16,
                enable: true
            }); this.input.addPointer(1);


            rightStick.on('pointerdown', () => {
                rightStick.clickStartTime = Date.now();
            });
            rightStick.on('pointerup', () => {
                const duration = Date.now() -
                    rightStick.clickStartTime;
                if (duration < 200) { manualFireRequested = true; }
            });
        } function
            update(time, delta) {
            if (isMissionComplete) return;
            if (this.tracks) {
                const now = this.time.now;
                this.tracks.children.each(track => {
                    const age = now - track.creationTime;
                    if (age > 5000) {
                        track.destroy();
                    } else {
                        track.setAlpha(0.5 * (1 - age / 5000));
                    }
                });
            }

            if (player) {
                player.update(time, cursors, this.input.activePointer);
            }
            sentries.forEach(s => s.update(time, player));

            rayGraphics.clear();
            if (debugGraphics) debugGraphics.clear();

            sentries.forEach(s => {
                if (!s.active) return;
                rayGraphics.fillStyle(0xff0000, 0.4);
                const startAngle = s.turret.rotation - Math.PI /
                    2 - s.visionAngle / 2;
                rayGraphics.slice(s.hull.x, s.hull.y,
                    s.visionRange, startAngle, startAngle +
                s.visionAngle, false);
                rayGraphics.fillPath();
            });

            if (activePowerup) {
                const bar =
                    document.getElementById('active-timer-bar');
                if (bar) {
                    const remaining = activePowerup.endTime - time;
                    const total = 10000;
                    const pct = Math.max(0, (remaining / total) *
                        100);
                    bar.style.width = pct + '%';
                }
            }
        }
    </script>
</body>

</html>